(function(kbd,$,undefined){var qtype;var config="Ctrl+H:help:U_lw_kbd_togglehelp";config+=",Ctrl+J:clear:U_lw_kbd_clearanswer";config+=",Ctrl+E:end:U_lw_kbd_end";config+=",Ctrl+F:flag:U_lw_kbd_flag";config+=",Ctrl+I:itemnav:U_lw_kbd_itemnav";config+=",Alt+P:prev:U_lw_kbd_prev";config+=",Alt+N:next:U_lw_kbd_next";config+=",A-E or 1-5:dummy:U_lw_kbd_mcq";config+=",Ctrl+Enter:answer:U_lw_kbd_answer";config+=",Alt+M:magnifier:U_lw_kbd_magnifier";config+=",Alt+H:highlighter:U_lw_kbd_highlighter";config+=
",Alt+E:eliminator:U_lw_kbd_eliminator";config+=",Alt+A:masking:U_lw_kbd_masking";config+=",Alt+L:linereader:U_lw_kbd_linereader";config+=",Up:up:*";config+=",Down:down:*";config+=",Enter:enter:*";config+=",Alt+Y:indent:U_lw_kbd_indent";var keybinds=[];kbd.boundkeys=function(){var bound=[];for(var i=0;i<keybinds.length;i++){var kb=keybinds[i];if(kb.help!=="*"&&kb.func!=="dummy"&&isEnabled(kb.func))bound.push(kb)}return bound};function questionType(evt){if(isExclusive())return false;if(evt.ctrlKey)return false;
if(evt.shiftKey)return false;if(evt.altKey)return false;if("metaKey"in evt&&evt.metaKey)return false;if(qtype!=1)return false;if(isAnswered())return false;var alt=-1;if(evt.which>=65&&evt.which<=90)alt=evt.which-65+1;else if(evt.which>=49&&evt.which<=57)alt=evt.which-49+1;else if(evt.which>=97&&evt.which<=105)alt=evt.which-97+1;else return false;qt.selectAlternative(alt);return true}function moveNavigationPointer(delta){var ptr=$("#itemNavModal .icon-play").closest(".navcol-current");var row=ptr.closest(".navrow");
if(delta>0){row=row.next();while(row.length>0&&!row.is(":visible"))row=row.next()}else{row=row.prev();while(row.length>0&&!row.is(":visible"))row=row.prev()}if(row.length==0)return;$(".navcol-current",row).html('<i class="icon-play"/>');var offset=$(".modal-body","#itemNavModal").scrollTop()+row.position().top-$(".modal-body","#itemNavModal").height()/2+row.height()/2;$(".modal-body","#itemNavModal").scrollTop(offset);ptr.html("")}function f_clear(evt){if(isExclusive())return;if(is_visible(".button-clear"))et2clear();
evt.preventDefault()}function f_end(evt){if(isExclusive())return;if(is_visible(".button-end"))endTest();evt.preventDefault()}function f_flag(evt){if($("#itemNavModal:visible").length>0){var ptr=$("#itemNavModal .icon-play").closest(".navcol-current");var row=ptr.closest(".navrow");$("input:checkbox",row).trigger("click");evt.preventDefault();return}if(isExclusive())return;if(is_visible(".button-markitem"))markitem();evt.preventDefault()}function f_itemnav(evt){if(isExclusive())return;if(is_visible(".button-itemnav"))itemnav();
evt.preventDefault()}function f_suspend(evt){if(isExclusive())return;if(is_visible(".button-suspend"))suspendTest();evt.preventDefault()}function f_prev(evt){if(isExclusive())return;if(is_visible(".button-prev-order"))prev(1);else if(is_visible(".button-prev-unanswered"))prev(2);evt.preventDefault()}function f_next(evt){if(isExclusive())return;if(is_visible(".button-next-unanswered"))next(2);else if(is_visible(".button-next-order"))next(1);evt.preventDefault()}function f_answer(evt){if(isExclusive())return;
if(is_visible(".button-answer")||is_visible(".button-next"))answer();evt.preventDefault()}function f_magnifier(evt){tools.magnifier.toggle();evt.preventDefault()}function f_highlighter(evt){tools.highlighter.toggle();evt.preventDefault()}function f_highlight(evt){$(".ev_highlight").trigger("click");evt.preventDefault()}function f_eliminator(evt){if(isExclusive())return;tools.eliminator.toggle();evt.preventDefault()}function f_masking(evt){if(isExclusive())return;tools.masking.toggle();evt.preventDefault()}
function f_linereader(evt){if(isExclusive())return;tools.linereader.toggle();evt.preventDefault()}function f_up(evt){if($("#itemNavModal:visible").length>0){moveNavigationPointer(-1);evt.preventDefault()}}function f_down(evt){if($("#itemNavModal:visible").length>0){moveNavigationPointer(1);evt.preventDefault()}}function f_enter(evt){if($(document.activeElement).is("button"))return;if(is_visible("#endOfTimeModal")){$(".ev_endoftime_ok").trigger("click");evt.preventDefault();return}if(is_visible("#essayLimitModal")){$("#essayLimitModal").modal("hide");
evt.preventDefault();return}if($("#itemNavModal .navcol-current:visible").length>0){var ptr=$("#itemNavModal .icon-play").closest(".navcol-current");var row=ptr.closest(".navrow");$(row).trigger("click");evt.preventDefault()}}function f_zoomin(evt){$(".ev_zoomin").trigger("click");evt.preventDefault()}function f_zoomout(evt){$(".ev_zoomout").trigger("click");evt.preventDefault()}function f_zoomreset(evt){$(".ev_zoomreset").trigger("click");evt.preventDefault()}function handle_key(evt){if(is_visible("#pause"))return;
if(is_visible("#commentModal"))return;if(questionType(evt))return;for(var i=0;i<keybinds.length;i++){var kb=keybinds[i];if(kb.isMatch(evt)){kb.execute(evt);return}}}function handle_modal(evt){switch(evt.which){case 13:if($(document.activeElement).is("button"))return;if($("#confirmEndTestModal-ok:visible").length>0){$(".ev_confirm_endtest_ok").trigger("click");evt.preventDefault()}else if($("#itemNavModalBtnSuspend:visible").length>0){doSuspendTest();evt.preventDefault()}else if($("#itemNavModalBtnEnd:visible").length>
0){if($("#zoomtoolbar").length>0)noConfirmEndTest();else showConfirmEndTest();evt.preventDefault()}break;case 27:if($("#confirmEndTestModal-cancel:visible").length>0){$(".ev_confirm_endtest_cancel").trigger("click");evt.preventDefault()}break}}function getKeycode(key){if(key.length==1)return key.toUpperCase().charCodeAt(0);if(key==="enter")return 13;if(key==="esc")return 27;if(key==="space")return 32;if(key==="left")return 37;if(key==="up")return 38;if(key==="right")return 39;if(key==="down")return 40;
if(key==="plus")return[171,187,61,43];if(key==="minus")return[173,189,45];if(key==="numplus")return 107;if(key==="numminus")return 109;if(key==="numzero")return 96;if(key==="numone")return 97;if(key==="numtwo")return 98;if(key==="numthree")return 99;if(key==="numfour")return 100;if(key==="numfive")return 101;if(key==="numsix")return 102;if(key==="numseven")return 103;if(key==="numeight")return 104;if(key==="numnine")return 105;return-1}function keybind(shift,ctrl,alt,code,func,help){this.shift=shift;
this.ctrl=ctrl;this.alt=alt;this.keycode=code;this.func=func;this.help=gui_kbd[help]||help;function getString(charcode){var keycode;if($.isArray(charcode))keycode=charcode[0];else keycode=charcode;if(keycode==13)return"Enter";if(keycode==27)return"Esc";if(keycode==32)return"Space";if(keycode==37)return"Left";if(keycode==38)return"Up";if(keycode==39)return"Right";if(keycode==40)return"Down";if(keycode==187||keycode==171||keycode==61||keycode==43)return"Plus";if(keycode==189||keycode==173||keycode==
45)return"Minus";if(keycode==107)return"NumPlus";if(keycode==109)return"NumMinus";if(keycode==96)return"NumZero";return String.fromCharCode(keycode).toUpperCase()}function addString(txt,str){if(txt.length>0)txt+="+";txt+=str;return txt}this.isMatch=function(evt){if(shift!==evt.shiftKey)return false;if("metaKey"in evt){if(ctrl!==evt.metaKey&&ctrl!==evt.ctrlKey)return false}else if(ctrl!==evt.ctrlKey)return false;if(alt!==evt.altKey)return false;if($.isArray(this.keycode)){for(i=0;i<this.keycode.length;i++){var c=
this.keycode[i];if(c==evt.which)return true;if("key"in evt&&c==evt.key.charCodeAt(0))return true}return false}else return this.keycode===evt.which};this.execute=function(evt){if(func==="help")kbd.getHelp(evt);else if(func==="clear")f_clear(evt);else if(func==="end")f_end(evt);else if(func==="flag")f_flag(evt);else if(func==="itemnav")f_itemnav(evt);else if(func==="suspend")f_suspend(evt);else if(func==="prev")f_prev(evt);else if(func==="next")f_next(evt);else if(func==="answer")f_answer(evt);else if(func===
"magnifier")f_magnifier(evt);else if(func==="highlighter")f_highlighter(evt);else if(func==="highlight")f_highlight(evt);else if(func==="eliminator")f_eliminator(evt);else if(func==="masking")f_masking(evt);else if(func==="linereader")f_linereader(evt);else if(func==="up")f_up(evt);else if(func==="down")f_down(evt);else if(func==="enter")f_enter(evt);else if(func==="esc")f_esc(evt);else if(func==="zoomin")f_zoomin(evt);else if(func==="zoomout")f_zoomout(evt);else if(func==="zoomreset")f_zoomreset(evt);
else;};this.getKeybindStr=function(){var txt="";if(this.ctrl)txt=addString(txt,"Ctrl");if(this.shift)txt=addString(txt,"Shift");if(this.alt)txt=addString(txt,"Alt");txt=addString(txt,getString(this.keycode));return txt};this.getKeybindStrRaw=function(i){var txt="";if(this.ctrl)txt=addString(txt,"Ctrl");if(this.shift)txt=addString(txt,"Shift");if(this.alt)txt=addString(txt,"Alt");txt=addString(txt,this.keycode[i]);return txt};this.getHelp=function(){return this.help}}function dummykeybind(keys,help){this.keys=
keys;this.help=gui_kbd[help]||help;this.func="dummy";this.isMatch=function(evt){return false};this.getKeybindStr=function(){return keys};this.getHelp=function(){return this.help}}function isEnabled(funcname){if(funcname==="help")return true;else if(funcname==="clear")return is_visible(".button-clear");else if(funcname==="end")return is_visible(".button-end");else if(funcname==="flag")return is_visible(".button-markitem");else if(funcname==="itemnav")return is_visible(".button-itemnav");else if(funcname===
"suspend")return is_visible(".button-suspend");else if(funcname==="prev")return is_visible(".button-prev");else if(funcname==="next")return is_visible(".button-next");else if(funcname==="answer")return is_visible(".button-answer")||is_visible(".button-next");else if(funcname==="magnifier")return $(".ev_toolmag").length>0;else if(funcname==="highlighter")return $(".ev_toolhigh").length>0;else if(funcname==="highlight")return $(".ev_toolhigh").length>0;else if(funcname==="eliminator")return $(".ev_toolelim").length>
0;else if(funcname==="masking")return $(".ev_toolmask").length>0;else if(funcname==="linereader")return $(".ev_toolliner").length>0;else if(funcname==="up")return $("#itemNavModal:visible").length>0;else if(funcname==="down")return $("#itemNavModal:visible").length>0;else if(funcname==="enter")return $("#itemNavModal .navcol-current:visible").length>0;else if(funcname==="esc")return false;else if(funcname==="zoomin")return $(".ev_zoomin").length>0;else if(funcname==="zoomout")return $(".ev_zoomout").length>
0;else if(funcname==="zoomreset")return $(".ev_zoomreset").length>0;else if(funcname==="dummy")return true;else if(funcname==="indent")return $("#qtparams").data("type")==18;else return false}function isExclusive(){return is_visible(".exclusive-input")}kbd.getHelp=function(evt){if($("#cheatsheet:visible").length>0){$("#cheatsheet").hide();evt.preventDefault();return}var tbl=$("#cheatsheet table");tbl.empty();tbl.append("<tr><th>"+GUI_KBD_KEYBIND+"</th><th>"+GUI_KBD_FUNCTION+"</th></tr>");for(var i=
0;i<keybinds.length;i++){var kb=keybinds[i];if(kb.help!=="*"&&isEnabled(kb.func))tbl.append("<tr><td>"+kb.getKeybindStr()+"</td><td>"+kb.getHelp()+"</td></tr>")}evt.preventDefault();$("#cheatsheet").show();$("#cheatsheet").off("click");$("#cheatsheet").on("click",function(){$("#cheatsheet").hide()})};kbd.handle=handle_key;kbd.init=function(_qtype){qtype=_qtype;keybinds=[];var cfg=config;if(isEnabled("zoomin")){cfg+=",Ctrl+Plus:zoomin:U_lw_kbd_zoomin";cfg+=",Ctrl+Minus:zoomout:U_lw_kbd_zoomout";cfg+=
",Ctrl+NumPlus:zoomin:*";cfg+=",Ctrl+NumMinus:zoomout:*";cfg+=",Ctrl+0:zoomreset:U_lw_kbd_zoomreset";cfg+=",Ctrl+NumZero:zoomreset:*"}var kbs=cfg.split(",");$.each(kbs,function(i,val){var kb=val.split(":");var keys=kb[0].toLowerCase().split("+");if(kb[1]=="dummy"){keybinds.push(new dummykeybind(kb[0],kb[2]));return}var isShift=false;var isCtrl=false;var isAlt=false;var code=-1;$.each(keys,function(i,val){if(val=="shift")isShift=true;else if(val=="ctrl")isCtrl=true;else if(val=="alt")isAlt=true;else code=
getKeycode(val)});if(code==-1){log("Unknown keybinding rule: "+val);return}keybinds.push(new keybind(isShift,isCtrl,isAlt,code,kb[1],kb[2]))});$(document).off("keydown",handle_key);$(document).on("keydown",handle_key);$("#itemNavModal").off("keydown",handle_modal);$("#itemNavModal").on("keydown",handle_modal)}})(window.kbd=window.kbd||{},jQuery);
