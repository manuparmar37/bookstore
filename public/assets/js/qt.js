function qtBaseDef(){function qtBase(){this.edited=false}qtBase.prototype.init=function(){};qtBase.prototype.prepare=function(answer,restore){};qtBase.prototype.enter=function(answer,restore){};qtBase.prototype.answer=function(answerstr,params){var qtype=$("#qtparams").data("type");if(qtype==20){answerstr=answerstr.replace(/;(?=;)|;$/g,"; ");answerstr=answerstr.replace(/^;/," ;");answerstr=answerstr.replace(/^$/," ")}else if(qtype==21&&answerstr=="")answerstr="-1";var qid=$("#qtparams").data("qid");
var url="answer.do";params.answer=answerstr;params.qid=qid;params.ct=clock.now();if(this_itemevent!=null){params.ev_client=clock.now();params.ev_timer=clock.getValue();params.ev_timezone=-(new Date).getTimezoneOffset();this_itemevent=null}params.debuginfo="b="+BrowserDetect.browser+"&v="+BrowserDetect.version+"&o="+BrowserDetect.OSversion;if(params.nav==="end")internalEndTest2(url,params);else if(terminated){params.terminated=1;$.ajax({type:"GET",url:url,data:params})}else if($("#params").data("qafeedback"))$("#qapanelfeedback").load(url,
params,function(){setAnswered();setState();$("#qapanel-wrapper").dialog({position:{my:"left bottom",at:"left bottom",of:"#questionframe"},autoResize:true});$(".qapanel").css("z-index",1005)});else net.load("#question",url,params)};qtBase.prototype.exit=function(){};qtBase.prototype.leave=function(url,params){$(".drop-image").hide();params.ct=clock.now();net.load("#question",url,params)};qtBase.prototype.calcAnswer=function(callback){callback("OK","")};qtBase.prototype.getState=function(){return STATE_UNANSWERED};
qtBase.prototype.clearDoesEdit=function(){return true};qtBase.prototype.video=function(){if(!$("#mainvideo").length||isAnswered())return;var video=$("#mainvideo")[0];var videoRepeats=$("#qtparams").data("videomaxrepeats");var autoContinue=videoRepeats>0;$(".ev_repeat").click(function(){videoRepeats--;video.play()});$(".ev_continue").click(function(){doAnswer(null)});$("#mainvideo").on("ended",function(){if(videoRepeats>0){var msg="You may replay the video "+videoRepeats+" more times.";$("#repeatModal-contents").html(msg);
$("#repeatModal").modal("show")}else if(autoContinue)doAnswer(null)});if($("#qtparams").data("videoautostart")){video.play();if($("#qtparams").data("videoplaypause"))$(".video-ui").addClass("active")}};qtBase.prototype.allowReload=function(){return true};return qtBase}var qtBase=qtBaseDef();
function qtMCDef(){function qtMC(){var sqnum}qtMC.prototype=Object.create(qtBase.prototype);qtMC.prototype.constructor=qtMC;qtMC.prototype.selectAlternative=function(num){var alt=$("div.mc-table > div:nth-child("+num+") input.mc-checkbox");if(alt.length==0)return;if(alt.prop("disabled"))return;if(alt.attr("type")=="radio")alt.prop("checked",true);else if(alt.is(":checked"))alt.prop("checked",false);else alt.prop("checked",true);$(alt).closest(".subquestion-data").find(".mc-alt").removeClass("mc-alt-selected");
$(alt).closest(".mc-alt").addClass("mc-alt-selected");$(alt).focus();var id=$(alt).attr("id");$("#mag-"+id).prop("checked",$("#"+id).is(":checked"));setState()};qtMC.prototype.enter=function(answer,restore,_sqnum){if(typeof _sqnum==="undefined")_sqnum=0;sqnum=_sqnum;var sqd=$("#subquestion-data-"+sqnum);if(sqd.data("infoquestion")){$("input[id^='mcalt-"+sqnum+"-']").prop("checked",true);sqd.hide();var infotext=$("#qtparams").data("infotext");$(".button-answer").text(infotext)}else if(answer.length>
0){var aa=answer.split("c");if(aa.length>1){var c=parseInt(aa[1]);var sid="#sqd-"+sqnum+"-conf";$(sid).bootstrapSlider("setValue",c);if(c>0)$(sid).bootstrapSlider("enable")}$.each(aa[0].split(";"),function(altnum,altval){var n=parseInt(altval);var aid="#mcalt-"+sqnum+"-"+n;$(aid).prop("checked",true);var qnumber=$(aid).closest(".subquestion").data("qnumber");var alttext=$(aid).closest(".mc-alt").text();$("#mcqdisplay-"+qnumber).text(alttext.trim())})}$("input[id^=mcalt-"+sqnum+"-]").click(function(){$(this).closest(".subquestion-data").find(".mc-alt").removeClass("mc-alt-selected");
$(this).closest(".mc-alt").addClass("mc-alt-selected");var id=$(this).attr("id");$("#mag-"+id).prop("checked",$("#"+id).is(":checked"));setState()});var csl=$("#sqd-"+sqnum+"-conf");if(csl.length>0)csl.bootstrapSlider().on("slideStop",function(){setState()});$(".mc-alt input").click(function(){var qnumber=$(this).closest(".subquestion").data("qnumber");var alttext=$(this).closest(".mc-alt").text();$("#mcqdisplay-"+qnumber).text(alttext.trim())})};qtMC.prototype.calcAnswer=function(callback,sqnum){if(typeof sqnum===
"undefined")sqnum=0;var answer="";$("input[id^='mcalt-"+sqnum+"-']:checked").each(function(){if(answer.length>0)answer+=";";answer+=$(this).val()});if(answer.length==0)answer="-1";else $("#sqd-"+sqnum+"-conf").each(function(){answer+="c"+$(this).val()});if(callback==null)return answer;else callback("OK",answer)};qtMC.prototype.getState=function(sqnum){if(typeof sqnum==="undefined")sqnum=0;var sqd=$("#subquestion-data-"+sqnum);if(sqd.data("infoquestion"))return STATE_INAPP;var overwrite=$("#controls").data("answeroverwrite");
if(isAnswered()&&!overwrite)return STATE_ANSWERED;var x=0;var noconf=false;$("input[id^='mcalt-"+sqnum+"-']:checked").each(function(){x++;if($(this).data("confidence"))if(sqd.find(".confidence-slider").val()==0)noconf=true});if(x==0)return STATE_UNANSWERED;var nc=sqd.data("numcorrect");var rc=sqd.data("requirecomplete");if(rc&&x!=nc||noconf)return STATE_INCOMPLETE;if(isAnswered()&&overwrite)return STATE_ANSWERED;return STATE_COMPLETE};return qtMC}var qtMC=qtMCDef();
function qtHSDef(){function qtHS(){this.crossX=-1;this.crossY=-1}qtHS.prototype=Object.create(qtBase.prototype);qtHS.prototype.constructor=qtHS;function onlyHSclick(hs,x,y){var isMultiSelect=$("#qtparams").data("multiselect");if(!isMultiSelect)$(".hotspot").removeClass("selected");hs.toggleClass("selected");hs.data("coords",x+";"+y);setState()}qtHS.prototype.enter=function(answer,restore){var isOnlyHotspot=$("#qtparams").data("hsonly");if(isOnlyHotspot){$(".hotspot").click(function(e){var x=Math.round(e.pageX-
$("#mainimg").offset().left);var y=Math.round(e.pageY-$("#mainimg").offset().top);onlyHSclick($(this),x,y)});$(".hotspot").each(function(i,e){var hsX=$(e).position().left;var hsY=$(e).position().top;var hsW=$(e).width();var hsH=$(e).height();var coords=restore.split(";");for(var i=0;i<coords.length;i+=2){var x=coords[i];var y=coords[i+1];if(x>=hsX&&y>=hsY&&x<=hsX+hsW&&y<=hsY+hsH){onlyHSclick($(this),x,y);return}}});return}if(restore!=""){var coords=restore.split(";");this.crossX=coords[0];this.crossY=
coords[1];$("#hs-leftclick").css("left",qt.crossX+"px");$("#hs-leftclick").css("top",qt.crossY+"px");$("#hs-leftclick").show();setState()}$("#mainimg").click(function(e){qt.crossX=Math.round(e.pageX-$(this).offset().left);qt.crossY=Math.round(e.pageY-$(this).offset().top);$("#hs-leftclick").css("left",qt.crossX+"px");$("#hs-leftclick").css("top",qt.crossY+"px");$("#hs-leftclick").show();setState()})};qtHS.prototype.calcAnswer=function(callback){var isOnlyHotspot=$("#qtparams").data("hsonly");var answer=
"";if(isOnlyHotspot)$(".hotspot").each(function(i,e){if(!$(e).hasClass("selected"))return;var c=$(e).data("coords");if(c==null)return;if(answer!="")answer=answer+";";answer=answer+c});else answer=this.crossX+";"+this.crossY;callback("OK",answer)};qtHS.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;var selected=false;var isOnlyHotspot=$("#qtparams").data("hsonly");if(isOnlyHotspot){$(".hotspot").each(function(i,e){if(!$(e).hasClass("selected"))return;var c=$(e).data("coords");
if(c!=null){selected=true;return false}});if(selected)return STATE_COMPLETE;else return STATE_UNANSWERED}else if(this.crossX!=-1&&this.crossY!=-1)selected=true;if(selected)return STATE_COMPLETE;else return STATE_UNANSWERED};return qtHS}var qtHS=new qtHSDef;
function qtMatchDef(){function qtMatch(){}qtMatch.prototype=Object.create(qtBase.prototype);qtMatch.prototype.constructor=qtMatch;qtMatch.prototype.enter=function(answer,restore,sqnum){if(typeof sqnum==="undefined")sqnum=0;$.each(answer.split(";"),function(index,value){$("select[name='matchalt-"+sqnum+"-"+(index+1)+"']").val(value)});$("select[name^='matchalt-"+sqnum+"-']").change(function(){setState()})};qtMatch.prototype.calcAnswer=function(callback,sqnum){if(typeof sqnum==="undefined")sqnum=0;
var answer="";$("select[name^='matchalt-"+sqnum+"-']").each(function(){if(answer.length>0)answer+=";";answer+=$(this).val()});if(callback==null)return answer;else callback("OK",answer)};qtMatch.prototype.getState=function(sqnum){if(typeof sqnum==="undefined")sqnum=0;if(isAnswered())return STATE_ANSWERED;var n=0;var alts=$("select[name^='matchalt-"+sqnum+"-']");for(var i=0;i<alts.length;i++)if(alts[i].value!="-1")n++;if(n==alts.length)return STATE_COMPLETE;if(n>0)return STATE_INCOMPLETE;return STATE_UNANSWERED};
return qtMatch}var qtMatch=new qtMatchDef;
function qtFIBDef(){function qtFIB(){}qtFIB.prototype=Object.create(qtBase.prototype);qtFIB.prototype.constructor=qtFIB;qtFIB.prototype.enter=function(answer,restore,sqnum){if(typeof sqnum==="undefined")sqnum=0;$("input[id^='"+sqnum+"-bif']").change(function(){setState()});$($("input[type='text']")[0]).focus();$("input[data-accept], input[data-deny]").on("keydown",function(evt){var accept=$(this).data("accept");var deny=$(this).data("deny");if(deny&&evt.key.match(new RegExp(deny)))return false;if(accept){var key=
"which"in evt?evt.which:evt.keyCode;if(key==8||key==9||key==46||key>=35&&key<=40)return true;if(!evt.key.match(new RegExp(accept)))return false}});$("input[data-format]").each(function(){$(this).data("prev",$(this).val())});$("input[data-format]").on("input",function(evt){var txt=$(this).val();var fmt=$(this).data("format");var regex=new RegExp(fmt);if(!txt.match(regex)){$(this).val($(this).data("prev"));return false}else{$(this).data("prev",txt);return true}})};qtFIB.prototype.calcAnswer=function(callback,
sqnum){if(typeof sqnum==="undefined")sqnum=0;var answer="";for(i=0;true;i++){if($("#"+sqnum+"-bif"+i).length==0)break;if(i>0)answer+=";";answer+=escape($("#"+sqnum+"-bif"+i).val())}if(callback==null)return answer;else callback("OK",answer)};qtFIB.prototype.getState=function(sqnum){if(typeof sqnum==="undefined")sqnum=0;if(isAnswered())return STATE_ANSWERED;var t=$("input[id^='"+sqnum+"-bif']").length;var n=0;for(var i=0;i<t;i++){var field=$("#"+sqnum+"-bif"+i);if(field.val()=="")n++;else if(field.data("numeric")&&
!$.isNumeric(field.val()))n++}if(n==t)return STATE_UNANSWERED;if(n>0)return STATE_INCOMPLETE;return STATE_COMPLETE};return qtFIB}var qtFIB=new qtFIBDef;
function qtDnDDef(){function qtDnD(){}qtDnD.prototype=Object.create(qtBase.prototype);qtDnD.prototype.constructor=qtDnD;qtDnD.prototype.enter=function(answer,restore){var coords;if(restore!="")coords=restore.split(";");var spacingX=20;var spacingY=10;var answer=""+$("#qtparams").data("answer");var maxDropWidth=0;var maxDropHeight=0;var numDropImages=0;$(".drop-image").each(function(){maxDropWidth=Math.max($(this).width(),maxDropWidth);maxDropHeight=Math.max($(this).height(),maxDropHeight);numDropImages++});
$("#drop-heading").show();var dw=Math.max(maxDropWidth,$("#drop-heading").width(),80);var top=0;var left=-(dw+spacingX);$("#drop-heading").css({top:top,left:left});top+=$("#drop-heading").height()+spacingY;for(i=0;i<numDropImages;i++){if(restore!=""){var x=parseInt(coords[i*2]);var y=parseInt(coords[i*2+1]);$("#drop-image-"+i).css({top:y,left:x})}else $("#drop-image-"+i).css({top:top,left:left});$("#drop-image-"+i).show();top+=$("#drop-image-"+i).height()+spacingY;$("#drop-text-"+i).css({top:top,
left:left,width:dw});$("#drop-text-"+i).show();top+=$("#drop-text-"+i).height()+spacingY}var ww=$("#image").width()+dw+spacingX+20;var hh=Math.max($("#image").height(),top+20);$("#image-wrapper").css({width:ww+"px",height:hh+"px"});$("#image").css({float:"right"});$(".drop-image").draggable({containment:"#image-wrapper",stop:function(){setState()}});$(".drop-image").hover(function(){$(this).addClass("drop-image-hover")},function(){$(this).removeClass("drop-image-hover")})};qtDnD.prototype.calcAnswer=
function(callback){var answer="";$(".drop-image").each(function(){var pos=$(this).position();answer+=Math.round(pos.left+1)+";";answer+=Math.round(pos.top+1)+";"});callback("OK",answer)};qtDnD.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;var numDropImages=0;var numMoved=0;$(".drop-image").each(function(){if($(this).position().left>=0)numMoved++;numDropImages++});var sqd=$("#subquestion-data-0");var nc=sqd.data("numcorrect");var rc=sqd.data("requirecomplete");if(rc&&numMoved!=
nc)return STATE_INCOMPLETE;return numMoved==0?STATE_UNANSWERED:STATE_COMPLETE};return qtDnD}var qtDnD=new qtDnDDef;
function qtEssayDef(){function qtEssay(){qtBase.call(this)}qtEssay.prototype=Object.create(qtBase.prototype);qtEssay.prototype.constructor=qtEssay;var wordlimit;var charlimit;var wordmaxlimit;var wordcharlimit;var formatted;var spellcheck;var placeholder;var showingPlaceholder;var interval=10*1E3;var timerCookie=null;var last_save=null;var last_spent=null;var lastText=null;function save_essay(){var current=$("#qtparams").data("timerCookie");if(current!=timerCookie)return;var fmt=formatted?"html":
"text";var editor=tinymce.get("essay");if(!editor)return;var spent=clock.getTimeSpent();var text="";var save=false;if(!showingPlaceholder){text=editor.getContent({format:fmt});text=spellchecker.strip(text);if(text!=last_save)save=true}if(save){var wc=getWordCount(editor.getContent());if(wordmaxlimit>0&&wc.wordcount>wordmaxlimit)save=false;if(charmaxlimit>0&&wc.charcount>charmaxlimit)save=false}if(!save&&last_spent!=null&&spent-last_spent>55E3)save=true;if(save){last_spent=clock.getTimeSpent();var qid=
$("#qtparams").data("qid");var duration0=$("#qtparams").data("duration");$.post("itemProgress.do",{"progress":text,"qid":qid,"duration0":duration0,"time":last_spent});last_save=text}setTimeout(save_essay,interval)}function essay_changed(){setState();var x=tinymce.get("essay").getContent();var maged=tinymce.get("mag_essay");if(maged!=null){maged.setContent(x);if($("#words-container").is(":visible"))$("#mag_words-container").html($("#words-container").html());if($("#chars-container").is(":visible"))$("#mag_chars-container").html($("#chars-container").html())}if(spellcheck)spellchecker.update()}
function handleKbd(editor,kb,key,keycode){editor.shortcuts.add(key,kb.func,function(){kbd.handle({altKey:kb.alt,shiftKey:kb.shift,ctrlKey:kb.ctrl,code:keycode,which:keycode,preventDefault:function(){}})});if(BrowserDetect.OSversion.indexOf("Mac")==0&&kb.ctrl&&!kb.shift&&!kb.alt){var keymeta=key.replace("ctrl","meta");editor.shortcuts.add(keymeta,kb.func,function(){kbd.handle({altKey:kb.alt,shiftKey:kb.shift,ctrlKey:false,metaKey:kb.ctrl,code:keycode,which:keycode,key:String.fromCharCode(keycode),
preventDefault:function(){}})})}}function setupKeysArray(editor,kb){for(var i=0;i<kb.keycode.length;i++){var iterkey=kb.getKeybindStrRaw(i).toLowerCase();handleKbd(editor,kb,iterkey,kb.keycode[i])}}function setupKeysNonArray(editor,kb){var key=kb.getKeybindStr().toLowerCase();key=key.replace("enter","13");handleKbd(editor,kb,key,kb.keycode)}function setupKeys(editor,disableAll){var bound=kbd.boundkeys();editor.shortcuts.add("alt+y","Indent",function(){editor.execCommand("mceInsertContent",false,"&emsp;&emsp;")});
editor.shortcuts.add("alt+x","Next Word",function(){if(spellcheck)spellchecker.showNextWord()});$.each(bound,function(index,kb){if(kb.func!=="indent")if($.isArray(kb.keycode))setupKeysArray(editor,kb);else setupKeysNonArray(editor,kb)});if(disableAll){var orig_shortcuts_add=editor.shortcuts.add;editor.shortcuts.add=function(pattern,desc,cmdFunc,scope){return orig_shortcuts_add(pattern,desc,function(){},scope)}}}function getWordCount(txt){if(showingPlaceholder)return{wordcount:0,charcount:0};txt=txt.replace(/(<([^>]+)>)/ig,
"");txt=txt.replace(/&nbsp;/ig," ");txt=txt.replace(/&[a-z]+;/ig,"-");if(txt==null)txt="";txt=txt.replace(/(<([^>]+)>)/ig,"");txt=txt.replace(/\r/ig," ");txt=txt.replace(/\n/ig," ");var words=txt.split(" ");var wordcount=words.length;for(var i=0;i<words.length;i++)if(words[i]=="")wordcount--;txt=txt.replace(/ /g,"");var charcount=txt.length;return{wordcount:wordcount,charcount:charcount}}function hidePlaceholder(ed){if(!placeholder||!showingPlaceholder)return;tinymce.get("essay").setContent("");showingPlaceholder=
false}function showPlaceholder(ed){if(!placeholder||showingPlaceholder)return;if(setPlaceholderText())showingPlaceholder=true}function setPlaceholderText(){var txt=tinymce.get("essay").getContent();txt=txt.trim();if(txt!="")return false;var html=$("#essayPlaceholder").html();tinymce.get("essay").setContent(html);return true}function initEditor(editor){showingPlaceholder=false;var html=$("#essayRestore").html();if(html!=null&&html!=""){tinymce.get("essay").setContent(html);var fmt=formatted?"html":
"text";var text=tinymce.get("essay").getContent({format:fmt});text=spellchecker.strip(text);last_save=text;if(spellcheck)spellchecker.update(1)}else if(placeholder)showPlaceholder();else setPlaceholderText();setState()}var itf_count=0;function inlineToolbarFixup(){if($("#tbcont").data("fixup")=="1")return;itf_count=0;inlineToolbarFixup2()}function inlineToolbarFixup2(){if(itf_count>100)return;itf_count++;if($("#tbcont").children().length==0){setTimeout(inlineToolbarFixup2,50);return}$("#tbcont .mce-tinymce button").each(function(){var lbl=
$(this).parent().attr("aria-label");if(lbl==null)$(this).attr("aria-label",$(this).text())});$("#tbcont div[role=application]").attr("aria-label",GUI_ESSAY_ARIA_APPLICATION);$("#tbcont div[role=application] > div > div[role=group]").attr("aria-label",GUI_ESSAY_ARIA_GROUP);$("#tbcont div[role=application] > div > div[role=group] div[role=toolbar]:first-child").attr("aria-label",GUI_ESSAY_ARIA_TOOLBAR1);$("#tbcont div[role=application] > div > div[role=group] div[role=toolbar]:first-child + div").attr("aria-label",
GUI_ESSAY_ARIA_TOOLBAR2);$("#tbcont").data("fixup","1")}function updateCounts(wc){if(wordmaxlimit>0)$("#words").text(wordmaxlimit-wc.wordcount);else $("#words").text(wc.wordcount);if(charmaxlimit>0)$("#chars").text(charmaxlimit-wc.charcount);else $("#chars").text(wc.charcount)}qtEssay.prototype.enter=function(answer,restore){if(BrowserDetect.browser==="Explorer")reloadCount=0;timerCookie=clock.now();$("#qtparams").data("timerCookie",timerCookie);last_spent=clock.getTimeSpent();tinymce.EditorManager.execCommand("mceRemoveEditor",
true,"essay");wordlimit=$("#qtparams").data("limitwords");charlimit=$("#qtparams").data("limitchars");wordmaxlimit=$("#qtparams").data("maxlimitwords")||0;charmaxlimit=$("#qtparams").data("maxlimitchars")||0;formatted=$("#qtparams").data("formatted");placeholder=$("#qtparams").data("placeholder");spellcheck=$("#qtparams").data("spellcheck");var tinline=$("#params").data("tinymceinline")||false;if(tinline){var attrs={};$.each($("#essay")[0].attributes,function(idx,attr){attrs[attr.nodeName]=attr.nodeValue});
$("#essay").replaceWith(function(){return $("<div></div>",attrs).append($(this).contents())});$("#essay").before("<div id='tbcont'></div>");$("#essay").attr("aria-hidden","false")}if(!$("#qtparams").data("showwords"))$("#words-container").hide();if(!$("#qtparams").data("showchars"))$("#chars-container").hide();if(wordmaxlimit>0)$("#words").text(wordmaxlimit);if(charmaxlimit>0)$("#chars").text(charmaxlimit);pageCSS=[];$("link").each(function(){if($(this).attr("type")!="text/css")return;pageCSS.push($(this).attr("href"))});
bodyCSS=$("body").attr("class");showingPlaceholder=placeholder;var mceparams={selector:"#essay",content_css:pageCSS,body_class:bodyCSS,content_style:"body { -webkit-user-select: initial !important; -moz-user-select: initial !important; -ms-user-select: text !important; -o-user-select: initial !important; user-select: initial !important; }",theme:"modern",schema:"html5",menubar:false,inline:tinline,init_instance_callback:initEditor,elementpath:false,branding:false};if(formatted){if(tinline){mceparams.toolbar1=
"undo redo | styleselect | bold italic";mceparams.toolbar2="alignleft aligncenter alignright alignjustify | bullist numlist outdent indent";mceparams.fixed_toolbar_container="#tbcont";mceparams.content_css=null;mceparams.body_css=null;mceparams.content_style=null;if(spellcheck)mceparams.toolbar1+=" | et2spell"}else{mceparams.toolbar="undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent";if(spellcheck)mceparams.toolbar+=" | et2spell"}mceparams.setup=
function(ed){if(spellcheck)spellchecker.setupEditor(ed);ed.on("keyup",function(e){essay_changed()});ed.on("Dirty",function(e){essay_changed();tinymce.get("essay").setDirty(false)});ed.on("drop",function(event){event.preventDefault()});ed.on("focus",function(event){inlineToolbarFixup();hidePlaceholder()});ed.on("blur",function(event){showPlaceholder();if(tinline){$("#essay").removeClass("mce-edit-focus");return false}});ed.on("ResizeEditor",function(event){tools.magnifier.refresh()});ed.on("dragstart",
function(event){return false});setupKeys(ed,false)};tinymce.init(mceparams)}else{mceparams.plugins="paste";mceparams.paste_as_text=true;mceparams.toolbar=false;mceparams.setup=function(ed){ed.on("keyup",function(e){essay_changed()});ed.on("Dirty",function(e){essay_changed();tinymce.get("essay").setDirty(false)});ed.on("drop",function(event){event.preventDefault()});ed.on("focus",function(event){hidePlaceholder()});ed.on("blur",function(event){showPlaceholder()});ed.on("ResizeEditor",function(event){tools.magnifier.refresh()});
ed.on("dragstart",function(event){return false});setupKeys(ed,true)};tinymce.init(mceparams)}setTimeout(save_essay,interval)};qtEssay.prototype.calcAnswer=function(callback){var answer=$("textarea#essay").text();var editor=tinymce.get("essay");if(editor!=null){var fmt=formatted?"html":"text";answer=editor.getContent({format:fmt});answer=spellchecker.strip(answer)}if(showingPlaceholder)answer="";callback("OK",answer)};qtEssay.prototype.exit=function(){for(var i=0;i<tinymce.editors.length;i++){var ed=
tinymce.editors[i];ed.setContent("");ed.remove();ed.destroy()}};qtEssay.prototype.getState=function(){var txt=$("textarea#essay").text();var editor=tinymce.get("essay");if(editor!=null)try{txt=editor.getContent()}catch(e){editor=null}var wc=getWordCount(txt);wordmaxlimit=$("#qtparams").data("maxlimitwords")||0;charmaxlimit=$("#qtparams").data("maxlimitchars")||0;if(editor!=null)if(lastText!=null&&wordmaxlimit>0&&wc.wordcount>wordmaxlimit){editor.setContent(lastText);wc=getWordCount(lastText);var msg=
lang(GUI_ESSAY_MAX_WORDS,wordmaxlimit);$("#essayLimitModal-contents").text(msg);$("#essayLimitModal").modal("show")}else if(lastText!=null&&charmaxlimit>0&&wc.charcount>charmaxlimit){editor.setContent(lastText);wc=getWordCount(lastText);var msg=lang(GUI_ESSAY_MAX_CHARS,charmaxlimit);$("#essayLimitModal-contents").text(msg);$("#essayLimitModal").modal("show")}else lastText=editor.getContent();updateCounts(wc);if(isAnswered())return STATE_ANSWERED;var x=STATE_COMPLETE;if(wordlimit>0&&wc.wordcount<wordlimit)x=
STATE_INCOMPLETE;if(charlimit>0&&wc.charcount<charlimit)x=STATE_INCOMPLETE;if(wordmaxlimit>0&&wc.wordcount>wordmaxlimit)x=STATE_INCOMPLETE;if(charmaxlimit>0&&wc.charcount>charmaxlimit)x=STATE_INCOMPLETE;if(wc.wordcount==0&&wc.charcount==0)x=STATE_UNANSWERED;return x};qtEssay.prototype.allowReload=function(){return false};return qtEssay}var qtEssay=qtEssayDef();
function qtOrderDef(){function qtOrder(){}qtOrder.prototype=Object.create(qtBase.prototype);qtOrder.prototype.constructor=qtOrder;var margin=40;var spacingX=50;var spacingY=50;var maxDropWidth=0;var maxDropHeight=0;var numDropImages=0;var numDropBoxes=0;var maxImageDivHeight=0;var maxImageDivWidth=0;var maxBoxDivHeight=0;var position=0;qtOrder.prototype.enter=function(answer,restore){position=$("#qtparams").data("position");$("#image").css({width:300,height:300});switch(position){case 0:toptobottom();
break;case 1:bottomtotop();break;case 2:lefttoright();break;case 3:righttoleft();break;default:toptobottom();break}if(answer.length>0&&answer!="-1"){var boxes=answer.split(";");for(i=0;i<boxes.length;i++){var b=parseInt(boxes[i])-1;if(b>=0)snap($("#drop-image-"+i),b)}}$(".drop-image").draggable({stop:function(){drop($(this));setState()}})};function toptobottom(){computesizes();for(i=0;i<numDropImages;i++){var di=$("#drop-image-"+i);maxImageDivHeight=Math.max(di.height(),maxImageDivHeight);di.css({top:margin,
left:getStartingX(i)})}var y=margin+maxImageDivHeight+spacingY;for(i=0;i<numDropBoxes;i++){var db=$("#drop-box-"+i);var dba=$("#drop-box-actual-"+i);dba.css({width:maxDropWidth,height:maxDropHeight});db.css({top:y,left:getStartingX(i)});db.show();maxBoxDivHeight=Math.max(db.height(),maxBoxDivHeight)}horizontalborder()}function resetTTB(i){$("#drop-image-"+i).css({top:margin,left:getStartingX(i)})}function bottomtotop(){computesizes();var y=margin+maxImageDivHeight+spacingY;for(i=0;i<numDropImages;i++){var di=
$("#drop-image-"+i);di.css({top:y,left:getStartingX(i)})}for(i=0;i<numDropBoxes;i++){var db=$("#drop-box-"+i);var dba=$("#drop-box-actual-"+i);dba.css({width:maxDropWidth,height:maxDropHeight});db.css({top:margin,left:getStartingX(i)});db.show();maxBoxDivHeight=Math.max(db.height(),maxBoxDivHeight)}horizontalborder()}function resetBTT(i){var y=margin+maxImageDivHeight+spacingY;$("#drop-image-"+i).css({top:y,left:getStartingX(i)})}function lefttoright(){computesizes();var y=margin+maxImageDivHeight+
spacingY;for(i=0;i<numDropImages;i++){var di=$("#drop-image-"+i);di.css({top:getStartingY(i),left:margin})}var x=margin+maxImageDivWidth+spacingX;for(i=0;i<numDropBoxes;i++){var db=$("#drop-box-"+i);var dba=$("#drop-box-actual-"+i);dba.css({width:maxDropWidth,height:maxDropHeight});db.css({top:getStartingY(i),left:x});db.show();maxBoxDivHeight=Math.max(db.height(),maxBoxDivHeight)}verticalborder()}function resetLTR(i){$("#drop-image-"+i).css({top:getStartingY(i),left:margin})}function righttoleft(){computesizes();
var y=margin+maxImageDivWidth+spacingX;for(i=0;i<numDropImages;i++){var di=$("#drop-image-"+i);di.css({top:getStartingY(i),left:y})}for(i=0;i<numDropBoxes;i++){var db=$("#drop-box-"+i);var dba=$("#drop-box-actual-"+i);dba.css({width:maxDropWidth,height:maxDropHeight});db.css({top:getStartingY(i),left:margin});db.show();maxBoxDivHeight=Math.max(db.height(),maxBoxDivHeight)}verticalborder()}function resetRTL(i){var y=margin+maxImageDivWidth+spacingX;$("#drop-image-"+i).css({top:getStartingY(i),left:y})}
function computesizes(){numDropImages=0;$(".drop-image-actual").each(function(){maxDropWidth=Math.max(this.naturalWidth,maxDropWidth);maxDropHeight=Math.max(this.naturalHeight,maxDropHeight);numDropImages++});for(i=0;i<numDropImages;i++){var di=$("#drop-image-"+i);maxImageDivHeight=Math.max(di.height(),maxImageDivHeight);maxImageDivWidth=Math.max(di.width(),maxImageDivWidth)}numDropBoxes=$(".drop-box").length}function horizontalborder(){var w=maxDropWidth*numDropImages+spacingX*(numDropImages-1)+
margin*2;var h=maxImageDivHeight+maxBoxDivHeight+margin*2+spacingY;$("#image").css({width:w,height:h,border:"1px solid black"})}function verticalborder(){var w=maxDropWidth*2+spacingX+margin*2;var h=maxImageDivHeight*numDropImages+margin*numDropImages+spacingY;$("#image").css({width:w,height:h,border:"1px solid black"})}function getBox(img){var ia=img.find(".drop-image-actual");var io=ia.offset();var ix=io.left+ia.width()/2;var iy=io.top+ia.height()/2;var box=-3;$(".drop-box-actual").each(function(){var bp=
$(this).offset();if(ix<bp.left)return;if(ix>bp.left+$(this).width())return;if(iy<bp.top)return;if(iy>bp.top+$(this).height())return;box=$(this).data("number")});return box}function getStartingX(i){return i*(maxDropWidth+spacingX)+margin}function getStartingY(i){return i*(maxDropHeight+spacingY)+margin}function drop(img){var box=getBox(img);if(box<0)return;$(".drop-image").each(function(){if($(this)==img)return;if(getBox($(this))==box){var boxnr=$(this).data("number");switch(position){case 0:resetTTB(boxnr);
break;case 1:resetBTT(boxnr);break;case 2:resetLTR(boxnr);break;case 3:resetRTL(boxnr);break;default:resetTTB(boxnr);break}}});snap(img,box)}function snap(img,box){switch(position){case 0:snaptoptobottom(img,box);break;case 1:snapbottomtotop(img,box);break;case 2:snaplefttoright(img,box);break;case 3:snaprighttoleft(img,box);break;default:snaptoptobottom(img,box);break}}function snaptoptobottom(img,box){var ia=img.find(".drop-image-actual");var x=(maxDropWidth-ia[0].naturalWidth)/2+getStartingX(box)-
ia.position().left;var y=(maxDropHeight-ia[0].naturalHeight)/2+margin+maxImageDivHeight+spacingY-ia.position().top;img.css({left:x,top:y})}function snapbottomtotop(img,box){var ia=img.find(".drop-image-actual");var x=(maxDropWidth-ia[0].naturalWidth)/2+getStartingX(box)-ia.position().left;var y=(maxDropHeight-ia[0].naturalHeight)/2+margin-ia.position().top;img.css({left:x,top:y})}function snaplefttoright(img,box){var ia=img.find(".drop-image-actual");var x=(maxDropWidth-ia[0].naturalWidth)/2+margin+
maxImageDivWidth+spacingX-ia.position().left;var y=(maxDropHeight-ia[0].naturalHeight)/2+getStartingY(box)-ia.position().top;img.css({left:x,top:y})}function snaprighttoleft(img,box){var ia=img.find(".drop-image-actual");var x=(maxDropWidth-ia[0].naturalWidth)/2+margin-ia.position().left;var y=(maxDropHeight-ia[0].naturalHeight)/2+getStartingY(box)-ia.position().top;img.css({left:x,top:y})}qtOrder.prototype.calcAnswer=function(callback){var answer="";for(i=0;i<numDropImages;i++){if(i>0)answer+=";";
var b=getBox($("#drop-image-"+i))+1;answer+=""+b}callback("OK",answer)};qtOrder.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;var imgInBox=0;$(".drop-image").each(function(){if(getBox($(this))>=0)imgInBox++});if(imgInBox==numDropBoxes)return STATE_COMPLETE;if(imgInBox>0)return STATE_INCOMPLETE;return STATE_UNANSWERED};return qtOrder}var qtOrder=new qtOrderDef;
function qtInappDef(){var qtInapp=function(){isItembank=$("#params").data("isitembank");mapDrive=$("#params").data("mapdrive");docpath=$("#params").data("docpath");mapped=mapDrive?1:0};qtInapp.prototype=Object.create(qtBase.prototype);qtInapp.prototype.constructor=qtInapp;var url=null;var params;var xdelta;var isItembank;var mapDrive;var docpath;var mapped;function println(message){}function plugin(){return document.getElementById("plugin")}function cb_startup(status){if(status=="ERROR")reportError();
else if(mapDrive)plugin().et2async(cb_mapdone,"MAP_DRIVE");else plugin().et2async(cb_getmydocs,"GET_PROPERTY","my_documents")}function cb_getmydocs(status,dir){net.load("#question","question.html",{"docpath":dir+"\\"+docpath})}function cb_mapdone(status,dir){if(status=="ERROR")reportError();else{net.load("#question","question.html",{"docpath":dir});mappeddrive=dir}}function cb_start(status,code){if(status=="ERROR")if(code=="INCOMPATIBLE")reportIncompatible();else if(code=="FILE_LOCKED")reportLocked();
else if(code=="CALL_REJECTED")reportCOMError();else reportError()}function cb_gotourl(status,code,b){if(status=="ERROR"&&inapp!=undefined&&inapp!=null){undoLeaveQuestion();if(code==-1)reportWarnDialog();else reportError()}else{window.resizeTo(self.screen.availWidth,self.screen.availHeight);if(b)if(BrowserDetect.browser==="Explorer"&&BrowserDetect.version==9)xdelta=b;else xdelta=new Blob([b],{type:"application/octet-stream"});if(url==null)return;if(!xdelta){delete params.file;net.load("#question",
url,params)}else{params.file=xdelta;net.postblob(url,params,function(data){xdelta=undefined;cb_postblob(data)})}}}function cb_log(status,b){var now=new Date;var year=now.getFullYear();var month=now.getMonth()+1;if(month<10)month="0"+month;var day=now.getDate();var hour=now.getHours();var minutes=now.getMinutes();var seconds=now.getSeconds();var filename="psi-"+year+"-"+month+"-"+day+"-"+hour+"-"+minutes+"-"+seconds+".support";var myNav=navigator.userAgent.toLowerCase();if(myNav.indexOf("msie")!=-1&&
parseInt(myNav.split("msie")[1])<=9)preIE10save(filename,b,"application/octet-stream;charset=utf-8");else{var blob=new Blob([b],{type:"application/octet-stream"});saveAs(blob,filename)}}function preIE10save(filename,filecontent,mimetype){var w=window.open("about:blank","_blank");var doc=w.document;doc.open(mimetype,"replace");doc.save="text";doc.charset="UTF-8";doc.write(filecontent);doc.close();doc.execCommand("SaveAs",null,filename+".txt");w.close()}function cb_shutdown(status,code){if(status==
"ERROR"){end=false;suspend=false;if(code==-1)reportWarnDialog();else reportError()}else if(mapDrive)plugin().et2async(cb_unmap,"UNMAP_DRIVE",mappeddrive);else cb_unmap()}function cb_unmap(){plugin().et2async(null,"TERMINATE_BROKER");if(end)internalDoEnd();else if(suspend)internalDoSuspend()}qtInapp.prototype.shutdown=function(){plugin().et2async(cb_shutdown,"QUIT2")};qtInapp.prototype.init=function(){var ts_stid=$("#params").data("stid");var build=$("#params").data("build");var inappinfo=$("#params").data("inappinfo");
var office64=inappinfo.indexOf("o64")!=-1;println("PSIIAPlugin version: "+plugin().version);plugin().et2setup(println);if(!isItembank)plugin().et2async(cb_startup,"START_BROKER",office64?64:32,build+"/ekslwpack.do",ts_stid+"/inapp.do");else plugin().et2async(cb_startup,"START_BROKER",office64?64:32,build+"/ekslwpack.do")};qtInapp.prototype.enter=function(answer,restore){if(isAnswered()){$("#answered").show();return}var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);
var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");if(reqVersion==0)reqVersion=-1;if(!isItembank)plugin().et2async(cb_start,"START2",qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,window.outerHeight,reqVersion,qtparamp,"",docpath);else{var qpackurl=$("#inappparams").data("qpack");var oRequest=new XMLHttpRequest;oRequest.open("GET",qpackurl);
oRequest.responseType="blob";oRequest.onload=downloadinappIBdone;oRequest.send()}};function downloadinappIBdone(){var reader=new window.FileReader;reader.onloadend=function(){var qpack=reader.result;qpack=qpack.substr(qpack.indexOf(",")+1);var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");
if(reqVersion==0)reqVersion=-1;plugin().et2async(cb_start,"START2",qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,window.outerHeight,reqVersion,qtparamp,qpack,docpath)};reader.readAsDataURL(this.response)}qtInapp.prototype.answer=function(answerstr,_params){var qid=$("#qtparams").data("qid");url="answer.do";_params.answer=answerstr;_params.qid=qid;params=_params;plugin().et2async(cb_gotourl,"QUIT2");window.resizeTo(self.screen.availWidth,self.screen.availHeight)};
qtInapp.prototype.leave=function(_url,_params){url=_url;params=_params;plugin().et2async(cb_gotourl,"QUIT2")};qtInapp.prototype.calcAnswer=function(callback){plugin().et2async(callback,"SCORE")};qtInapp.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;else return STATE_INAPP};qtInapp.prototype.clearDoesEdit=function(){return false};qtInapp.prototype.getLog=function(){plugin().et2async(cb_log,"GET_LOG")};return qtInapp}var qtInapp=new qtInappDef;
function qtInappChromeDef(){var qtInappChrome=function(){isItembank=$("#params").data("isitembank");mapDrive=$("#params").data("mapdrive");docpath=$("#params").data("docpath");mapped=mapDrive?1:0};qtInappChrome.prototype=Object.create(qtBase.prototype);qtInappChrome.prototype.constructor=qtInappChrome;var url=null;var params;var xdelta;var port;var packdata;var packname;var ts_stid;var office64;var scorecallback;var build;var inappinfo;var isItembank;var mapDrive;var docpath;var mapped;var pendingMsg=
undefined;function println(message){}function cb_startup(status){if(status=="ERROR")reportError();else if(mapDrive)port.postMessage({command:"MAP_DRIVE",arguments:[]});else port.postMessage({command:"GET_PROPERTY",arguments:["my_documents"]})}function cb_getmydocs(status,dir){net.load("#question","question.html",{"docpath":dir+"\\"+docpath})}function cb_mapdone(status,dir){if(status=="ERROR")reportError();else{net.load("#question","question.html",{"docpath":dir});mappeddrive=dir}}function cb_start(status,
code){if(status=="ERROR")if(code=="INCOMPATIBLE")reportIncompatible();else if(code=="FILE_LOCKED")reportLocked();else if(code=="CALL_REJECTED")reportCOMError();else reportError()}function cb_gotourl(status,code,b){if(status=="ERROR"&&inapp!=undefined&&inapp!=null){undoLeaveQuestion();if(code==-1)reportWarnDialog();else reportError()}else{window.resizeTo(self.screen.availWidth,self.screen.availHeight);if(b)xdelta=new Blob([b],{type:"application/octet-stream"});if(url==null)return;if(!xdelta){delete params.file;
net.load("#question",url,params)}else{params.file=xdelta;net.postblob(url,params,function(data){xdelta=undefined;cb_postblob(data)})}}}function cb_log(status,b){var now=new Date;var year=now.getFullYear();var month=now.getMonth()+1;if(month<10)month="0"+month;var day=now.getDate();var hour=now.getHours();var minutes=now.getMinutes();var seconds=now.getSeconds();var filename="psi-"+year+"-"+month+"-"+day+"-"+hour+"-"+minutes+"-"+seconds+".support";var blob=new Blob([b],{type:"application/octet-stream"});
saveAs(blob,filename)}function cb_shutdown(status,code){if(status=="ERROR"){end=false;suspend=false;if(code==-1)reportWarnDialog();else reportError()}else if(mapDrive)port.postMessage({command:"UNMAP_DRIVE",arguments:[mappeddrive]});else cb_unmap()}function cb_unmap(){port.postMessage({command:"TERMINATE_BROKER",arguments:[]});if(end)internalDoEnd();else if(suspend)internalDoSuspend()}function cb_checkExtension(reply){if(reply){setupPort();packname=build+"/ekslwpack.do";var oRequest=new XMLHttpRequest;
oRequest.open("GET",packname);oRequest.responseType="blob";oRequest.onload=downloadpackdone;oRequest.send()}else{alert("No In-Application Extension found");internalDoSuspend()}}qtInappChrome.prototype.shutdown=function(){port.postMessage({command:"QUIT2",arguments:[]})};qtInappChrome.prototype.init=function(){ts_stid=$("#params").data("stid");build=$("#params").data("build");inappinfo=$("#params").data("inappinfo");office64=inappinfo.indexOf("o64")!=-1;var extensionId="leneiifcmnfminekdbgbofkdddlkhcep";
chrome.runtime.sendMessage(extensionId,{command:"ECHO",arguments:[]},cb_checkExtension)};function downloadpackdone(){var reader=new window.FileReader;reader.onloadend=function(){packdata=reader.result;packdata=packdata.substr(packdata.indexOf(",")+1);if(!isItembank){var oRequest=new XMLHttpRequest;oRequest.open("GET",ts_stid+"/inapp.do");oRequest.responseType="blob";oRequest.onload=downloadinappdone;oRequest.send()}else port.postMessage({command:"START_BROKER",bits:office64?64:32,buildname:packname,
build:packdata})};reader.readAsDataURL(this.response)}function downloadinappdone(){var reader=new window.FileReader;reader.onloadend=function(){var inappdata=reader.result;inappdata=inappdata.substr(inappdata.indexOf(",")+1);port.postMessage({command:"START_BROKER",bits:office64?64:32,buildname:packname,build:packdata,inappname:ts_stid+"/inapp.do",inapp:inappdata})};reader.readAsDataURL(this.response)}function downloadinappIBdone(){var reader=new window.FileReader;reader.onloadend=function(){var qpack=
reader.result;qpack=qpack.substr(qpack.indexOf(",")+1);var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");if(reqVersion==0)reqVersion=-1;port.postMessage({command:"START2",arguments:[qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,window.outerHeight,reqVersion,
qtparamp,qpack,docpath]})};reader.readAsDataURL(this.response)}function setupPort(){var extensionId="leneiifcmnfminekdbgbofkdddlkhcep";port=chrome.runtime.connect(extensionId);port.onMessage.addListener(function(msg){if("part"in msg&&msg.part!=-1){if(pendingMsg==undefined){pendingMsg=msg;return}pendingMsg.arguments[msg.arguments.length-1]+=msg.arguments[msg.arguments.length-1];if(msg.done){msg=pendingMsg;pendingMsg=undefined}else return}if(msg.command=="PING")port.postMessage({command:"PONG",arguments:["OK"]});
else if(msg.command=="START2")cb_start(msg.arguments[0],msg.arguments[1]);else if(msg.command=="QUIT2")if(!end&&!suspend)cb_gotourl(msg.arguments[0],msg.arguments[1],msg.arguments[2]);else cb_shutdown(msg.arguments[0],msg.arguments[1]);else if(msg.command=="SCORE")scorecallback(msg.arguments[0],msg.arguments[1]);else if(msg.command=="GET_LOG")cb_log(msg.arguments[0],msg.arguments[1]);else if(msg.command=="MAP_DRIVE")cb_mapdone(msg.arguments[0],msg.arguments[1]);else if(msg.command=="START_BROKER")cb_startup(msg.arguments[0]);
else if(msg.command=="UNMAP_DRIVE")cb_unmap();else if(msg.command=="GET_PROPERTY")cb_getmydocs(msg.arguments[0],msg.arguments[1]);else if(msg.command=="TERMINATE_BROKER");});port.onDisconnect.addListener(function(){window.close()})}qtInappChrome.prototype.enter=function(answer,restore){if(isAnswered()){$("#answered").show();return}var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");
var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");if(reqVersion==0)reqVersion=-1;if(!isItembank)port.postMessage({command:"START2",arguments:[qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,window.outerHeight,reqVersion,qtparamp,null,docpath]});else{var qpackurl=$("#inappparams").data("qpack");var oRequest=new XMLHttpRequest;oRequest.open("GET",qpackurl);oRequest.responseType="blob";oRequest.onload=downloadinappIBdone;
oRequest.send()}};qtInappChrome.prototype.answer=function(answerstr,_params){var qid=$("#qtparams").data("qid");url="answer.do";_params.answer=answerstr;_params.qid=qid;params=_params;port.postMessage({command:"QUIT2",arguments:[]});window.resizeTo(self.screen.availWidth,self.screen.availHeight)};qtInappChrome.prototype.leave=function(_url,_params){url=_url;params=_params;port.postMessage({command:"QUIT2",arguments:[]})};qtInappChrome.prototype.calcAnswer=function(callback){scorecallback=callback;
port.postMessage({command:"SCORE",arguments:[]})};qtInappChrome.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;else return STATE_INAPP};qtInappChrome.prototype.clearDoesEdit=function(){return false};qtInappChrome.prototype.getLog=function(){port.postMessage({command:"GET_LOG",arguments:[]})};return qtInappChrome}var qtInappChrome=new qtInappChromeDef;
function qtInappFirefoxDef(){function qtInappFirefox(){isItembank=$("#params").data("isitembank");mapDrive=$("#params").data("mapdrive");docpath=$("#params").data("docpath");mapped=mapDrive?1:0}qtInappFirefox.prototype=Object.create(qtBase.prototype);qtInappFirefox.prototype.constructor=qtInappFirefox;var url=null;var params;var xdelta;var port;var packdata;var packname;var ts_stid;var office64;var scorecallback;var build;var inappinfo;var isItembank;var mapDrive;var docpath;var mapped;var messenger;
var pendingMsg=undefined;function println(message){}function cb_startup(status){if(status=="ERROR")reportError();else if(mapDrive)postToExtension({command:"MAP_DRIVE",arguments:[]});else postToExtension({command:"GET_PROPERTY",arguments:["my_documents"]})}function cb_getmydocs(status,dir){net.load("#question","question.html",{"docpath":dir+"\\"+docpath})}function cb_mapdone(status,dir){if(status=="ERROR")reportError();else{net.load("#question","question.html",{"docpath":dir});mappeddrive=dir}}function cb_start(status,
code){if(status=="ERROR")if(code=="INCOMPATIBLE")reportIncompatible();else if(code=="FILE_LOCKED")reportLocked();else if(code=="CALL_REJECTED")reportCOMError();else reportError()}function cb_gotourl(status,code,b){if(status=="ERROR"&&inapp!=undefined&&inapp!=null){undoLeaveQuestion();if(code==-1)reportWarnDialog();else reportError()}else{window.resizeTo(self.screen.availWidth,self.screen.availHeight);if(b)xdelta=new Blob([b],{type:"application/octet-stream"});if(url==null)return;if(!xdelta){delete params.file;
net.load("#question",url,params)}else{params.file=xdelta;net.postblob(url,params,function(data){xdelta=undefined;cb_postblob(data)})}}}function cb_log(status,b){var now=new Date;var year=now.getFullYear();var month=now.getMonth()+1;if(month<10)month="0"+month;var day=now.getDate();var hour=now.getHours();var minutes=now.getMinutes();var seconds=now.getSeconds();var filename="psi-"+year+"-"+month+"-"+day+"-"+hour+"-"+minutes+"-"+seconds+".support";var blob=new Blob([b],{type:"application/octet-stream"});
saveAs(blob,filename)}function cb_shutdown(status,code){if(status=="ERROR"){end=false;suspend=false;if(code==-1)reportWarnDialog();else reportError()}else if(mapDrive)postToExtension({command:"UNMAP_DRIVE",arguments:[mappeddrive]});else cb_unmap()}function cb_unmap(){postToExtension({command:"TERMINATE_BROKER",arguments:[]});if(end)internalDoEnd();else if(suspend)internalDoSuspend()}function cb_checkExtension(reply){if(reply){setupPort();packname=build+"/ekslwpack.do";var oRequest=new XMLHttpRequest;
oRequest.open("GET",packname);oRequest.responseType="blob";oRequest.onload=downloadpackdone;oRequest.send()}else{alert("No In-Application Extension found");internalDoSuspend()}}qtInappFirefox.prototype.shutdown=function(){postToExtension({command:"QUIT2",arguments:[]})};qtInappFirefox.prototype.init=function(){ts_stid=$("#params").data("stid");build=$("#params").data("build");inappinfo=$("#params").data("inappinfo");office64=inappinfo.indexOf("o64")!=-1;document.addEventListener("extensionready",
onExtensionReady,false,true);document.addEventListener("extension2page",onExtensionMessage,false,true)};function postToExtension(msg){$("#extensionevents").attr("msg",JSON.stringify(msg));var ev=document.createEvent("Events");ev.initEvent("page2extension",true,false);var element=document.getElementById("extensionevents");element.dispatchEvent(ev)}function onExtensionReady(event){postToExtension({command:"ECHO",arguments:[]})}function onExtensionMessage(event){var msg=JSON.parse(event.target.getAttribute("extmsg"));
if("part"in msg&&msg.part!=-1){if(pendingMsg==undefined){pendingMsg=msg;return}pendingMsg.arguments[msg.arguments.length-1]+=msg.arguments[msg.arguments.length-1];if(msg.done){msg=pendingMsg;pendingMsg=undefined}else return}if(msg.command=="ECHO"){packname=build+"/ekslwpack.do";var oRequest=new XMLHttpRequest;oRequest.open("GET",packname);oRequest.responseType="blob";oRequest.onload=downloadpackdone;oRequest.send()}else if(msg.command=="PING")postToExtension({command:"PONG",arguments:["OK"]});else if(msg.command==
"START2")cb_start(msg.arguments[0],msg.arguments[1]);else if(msg.command=="QUIT2")if(!end&&!suspend)cb_gotourl(msg.arguments[0],msg.arguments[1],msg.arguments[2]);else cb_shutdown(msg.arguments[0],msg.arguments[1]);else if(msg.command=="SCORE")scorecallback(msg.arguments[0],msg.arguments[1]);else if(msg.command=="GET_LOG")cb_log(msg.arguments[0],msg.arguments[1]);else if(msg.command=="MAP_DRIVE")cb_mapdone(msg.arguments[0],msg.arguments[1]);else if(msg.command=="START_BROKER")cb_startup(msg.arguments[0]);
else if(msg.command=="UNMAP_DRIVE")cb_unmap();else if(msg.command=="GET_PROPERTY")cb_getmydocs(msg.arguments[0],msg.arguments[1]);else if(msg.command=="TERMINATE_BROKER");}function downloadpackdone(){var reader=new window.FileReader;reader.onloadend=function(){packdata=reader.result;packdata=packdata.substr(packdata.indexOf(",")+1);if(!isItembank){var oRequest=new XMLHttpRequest;oRequest.open("GET",ts_stid+"/inapp.do");oRequest.responseType="blob";oRequest.onload=downloadinappdone;oRequest.send()}else postToExtension({command:"START_BROKER",
bits:office64?64:32,buildname:packname,build:packdata})};reader.readAsDataURL(this.response)}function downloadinappdone(){var reader=new window.FileReader;reader.onloadend=function(){var inappdata=reader.result;inappdata=inappdata.substr(inappdata.indexOf(",")+1);postToExtension({command:"START_BROKER",bits:office64?64:32,buildname:packname,build:packdata,inappname:ts_stid+"/inapp.do",inapp:inappdata})};reader.readAsDataURL(this.response)}function downloadinappIBdone(){var reader=new window.FileReader;
reader.onloadend=function(){var qpack=reader.result;qpack=qpack.substr(qpack.indexOf(",")+1);var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");if(reqVersion==0)reqVersion=-1;postToExtension({command:"START2",arguments:[qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,
window.outerHeight,reqVersion,qtparamp,qpack,docpath]})};reader.readAsDataURL(this.response)}function setupPort(){var extensionId="PSI In-application Extension";port=browser.runtime.connect(extensionId);port.onMessage.addListener(function(msg){if(msg.command=="PING")port.postMessage({command:"PONG",arguments:["OK"]});else if(msg.command=="START2")cb_start(msg.arguments[0],msg.arguments[1]);else if(msg.command=="QUIT2")if(!end&&!suspend)cb_gotourl(msg.arguments[0],msg.arguments[1],msg.arguments[2]);
else cb_shutdown(msg.arguments[0],msg.arguments[1]);else if(msg.command=="SCORE")scorecallback(msg.arguments[0],msg.arguments[1]);else if(msg.command=="GET_LOG")cb_log(msg.arguments[0],msg.arguments[1]);else if(msg.command=="MAP_DRIVE")cb_mapdone(msg.arguments[0],msg.arguments[1]);else if(msg.command=="START_BROKER")cb_startup(msg.arguments[0]);else if(msg.command=="UNMAP_DRIVE")cb_unmap();else if(msg.command=="TERMINATE_BROKER");});port.onDisconnect.addListener(function(){window.close()})}qtInappFirefox.prototype.enter=
function(answer,restore){if(isAnswered()){$("#answered").show();return}var width=window.outerWidth;var height=window.outerHeight;window.resizeTo(width,300);var qid=$("#qtparams").data("qid");var qtparams=$("#qtparams").data("inappparams");var qtparamp=$("#qtparams").data("inappparamp");var reqVersion=$("#params").data("officeversion");if(reqVersion==0)reqVersion=-1;if(!isItembank)postToExtension({command:"START2",arguments:[qid,mapped,qtparams,self.screen.width,self.screen.availHeight,window.outerWidth,
300,reqVersion,qtparamp,null,docpath]});else{var qpackurl=$("#inappparams").data("qpack");var oRequest=new XMLHttpRequest;oRequest.open("GET",qpackurl);oRequest.responseType="blob";oRequest.onload=downloadinappIBdone;oRequest.send()}};qtInappFirefox.prototype.answer=function(answerstr,_params){var qid=$("#qtparams").data("qid");url="answer.do";_params.answer=answerstr;_params.qid=qid;params=_params;postToExtension({command:"QUIT2",arguments:[]});window.resizeTo(self.screen.availWidth,self.screen.availHeight)};
qtInappFirefox.prototype.leave=function(_url,_params){url=_url;params=_params;postToExtension({command:"QUIT2",arguments:[]})};qtInappFirefox.prototype.calcAnswer=function(callback){scorecallback=callback;postToExtension({command:"SCORE",arguments:[]})};qtInappFirefox.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;else return STATE_INAPP};qtInappFirefox.prototype.clearDoesEdit=function(){return false};qtInappFirefox.prototype.getLog=function(){postToExtension({command:"GET_LOG",
arguments:[]})};return qtInappFirefox}var qtInappFirefox=new qtInappFirefoxDef;function messageContentScript(){window.postMessage({direction:"from-page-script",message:"Message from the page"},"*")}
function qtTutorDef(){function qtTutor(){}qtTutor.prototype=Object.create(qtBase.prototype);qtTutor.prototype.constructor=qtTutor;qtTutor.prototype.enter=function(answer,restore){lookup_reset();$(".tutor_urlmapping span").each(function(){lookup_add($(this).data("key"),$(this).data("value"))});if(isAnswered()){$("li.navitem.active a").focus();$("li.navitem.active a").focusout(function(){setTimeout(function(){$("li.navitem.active a").focus()},10)});var autoanswer=parseInt($("#qtparams").data("autoanswer"));
if(autoanswer>0){$("#answered").show();return}}KSTutorQuestion.enter(answer,restore)};qtTutor.prototype.exit=function(){KSTutorQuestion.exit()};qtTutor.prototype.calcAnswer=function(callback){KSTutorQuestion.calcAnswer(callback)};qtTutor.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;return KSTutorQuestion.getState()};return qtTutor}var qtTutor=new qtTutorDef;
function qtReactionDef(){function qtReaction(){}qtReaction.prototype=Object.create(qtBase.prototype);qtReaction.prototype.constructor=qtReaction;var clicks=[];var maxClicks=1E3;var video;var qaTimer;var qaReacts=[];var fps=null;qtReaction.prototype.enter=function(answer,restore){if(isAnswered())return;if($("#qtparams").data("fps"))fps=parseFloat($("#qtparams").data("fps"));var qainfo=$("#qtparams").data("qainfo");video=$("#mainvideo")[0];$("#mainvideo").on("contextmenu",function(){return false});
$("#mainvideo").mousedown(function(){if(clicks.length<maxClicks){var t=Math.round(video.currentTime*1E3);if(qainfo){var rt="";for(i=0;i<qaReacts.length;i++){var rct=qaReacts[i];if(rt.length>0)rt+=";";rt+=rct.getPoints(t)}$("#reaction-overlay").append('<span class="reaction-qa-click">'+rt+"</span>")}else $("#reaction-overlay").append("<img src='"+reactionFlagUrl+"' class='reaction-flag' />");clicks.push(t)}});$("#mainvideo").on("ended",function(){doAnswer(null)});$("#mainvideo").keydown(function(e){e.preventDefault();
e.stopPropagation();return false});if(qainfo){$(document).keydown(function(e){var n=0;var c=e.which;if(c>=97&&c<=105)n=c-96;if(c>=49&&c<=57)n=c-48;if(n>0){var rate=1/n;video.playbackRate=rate;$("#reaction-qa-rate").text("rate = "+rate.toFixed(3))}});var dr=qainfo.split("|");for(i=0;i<dr.length;i++){var dx=dr[i].split(";");var react={name:dx[0],start:parseInt(dx[1]),length:[],points:[],getPoints:function(ms){var t=this.start;if(t>ms)return 0;for(j=0;j<this.points.length;j++){t+=this.length[j];if(t>
ms)return this.points[j]}return 0}};for(j=2;j<dx.length;j+=2){react.length.push(parseInt(dx[j]));react.points.push(parseInt(dx[j+1]))}qaReacts.push(react)}qaTimer=setInterval(function(){var sec=video.currentTime;var ts;if(fps!=null)ts=pad(Math.floor(sec*fps),6)+"f"+", "+pad(Math.floor(sec),4)+":"+pad(Math.floor(sec%1*fps),2)+"s:f";else ts=sec.toFixed(3)+"s";$("#reaction-qa-timestamp").text(ts);var ms=sec*1E3;var rt="";for(i=0;i<qaReacts.length;i++){var rct=qaReacts[i];var p=rct.getPoints(ms);if(p>
0){if(rt.length>0)rt+=", ";rt+=rct.name+": "+p}}$("#reaction-qa-reactions").text(rt)},40)}video.play()};qtReaction.prototype.getPoints=function(rct,ms){var t=rct.start;if(t>ms)return 0;for(j=0;j<rct.points.length;j++){t+=rct.length[j];if(t>ms)return rct.points[j]}return 0};qtReaction.prototype.calcAnswer=function(callback){var answer="";for(i=0;i<clicks.length;i++){if(answer.length>0)answer+=";";answer+=clicks[i]}callback("OK",answer)};qtReaction.prototype.getState=function(){return STATE_INAPP};
qtReaction.prototype.video=function(){};return qtReaction}var qtReaction=new qtReactionDef;
function qtAudioCaptureDef(){function qtAudioCapture(){}qtAudioCapture.prototype=Object.create(qtBase.prototype);qtAudioCapture.prototype.constructor=qtAudioCapture;var captureLength;var samplerate=44100;var captureNumber;var recorder;var processor;var microphone;var analyser;var chunks=[];var audioConstraints={audio:{mimetype:"audio/ogg",channelCount:1,sampleRate:samplerate,sampleSize:16,volume:1}};qtAudioCapture.prototype.enter=function(answer,restore){if(audioCtx==null&&window.AudioContext)audioCtx=
new AudioContext;audioblob=[]};qtAudioCapture.prototype.answer=function(answerstr,params){var qid=$("#qtparams").data("qid");params.answer=answerstr;params.qid=qid;params.ct=clock.now();var rid=$("#params").data("resultid");if(rid==="preview"){net.load("#question","answer.do",params);return}var arrays=[];var names=[];var md5sum=[];var count=audioblob.length;$.each(audioblob,function(index,blob){if(blob.type=="audio/mp3")names[index]="mp3_"+index;else names[index]="ogg_"+index;var r=new FileReader;
r.onload=function(event){arrays[index]=new Uint8Array(event.target.result);md5sum[index]=md5(arrays[index]);if(--count==0){audioblob=[];if(params.nav==="end")internalEndTest2("answer.do",params,"upload.do",names,arrays,md5sum);else net.postblobSafe("upload.do",names,arrays,md5sum,function(){net.load("#question","answer.do",params)})}};r.readAsArrayBuffer(blob)})};qtAudioCapture.prototype.calcAnswer=function(callback){callback("OK",audioblob[0]?audioblob[0].size:"0")};qtAudioCapture.prototype.getState=
function(){if(isAnswered())return STATE_ANSWERED;else if(audioblob[0]&&audioblob[0].size>0)return STATE_COMPLETE;else return STATE_UNANSWERED};qtAudioCapture.prototype.start=function(num,duration){captureNumber=parseInt(num);if(duration)captureLength=parseInt(duration);else captureLength=undefined;getStream().then(gotStream).catch(recordfail)};qtAudioCapture.prototype.stop=function(){if(recorder!=null)recorder.stop();if(microphone!=null)microphone.disconnect();if(analyser!=null)analyser.disconnect();
if(processor!=null)processor.disconnect();recorder=null;microphone=null;analyser=null;processor=null;$("#audiocap-indicator").removeClass("active");var capturecount=$("#qtparams").data("capturecount");capturecount=parseInt(capturecount);if(captureNumber+1<capturecount)setTaskBar(captureNumber+1)};function getStream(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)return navigator.mediaDevices.getUserMedia(audioConstraints);var getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||
navigator.mozGetUserMedia||navigator.msGetUserMedia;return new Promise(function(resolve,reject){getUserMedia.call(navigator,audioConstraints,resolve,reject)})}function gotStream(s){$("#audiocap-indicator").addClass("active");if(MediaRecorder.isTypeSupported("audio/mp3")){analyser=audioCtx.createAnalyser();analyser.smoothingTimeConstant=.3;analyser.fftSize=1024;microphone=audioCtx.createMediaStreamSource(s);microphone.connect(analyser);var processor=audioCtx.createScriptProcessor(1024,1,1);processor.onaudioprocess=
function(){audiocapIndicator(analyser)};analyser.connect(processor);recorder=new MediaRecorder(s,{audioBitsPerSecond:64E3,mimeType:"audio/mp3"})}else recorder=new MP3MediaRecorder(audioCtx,s);chunks=[];recorder.ondataavailable=function(ev){chunks.push(ev.data)};recorder.onstop=function(){var b=new Blob(chunks,{type:chunks[0].type});audioblob[captureNumber]=b;chunks=[];setState()};recorder.start();if(captureLength)capturetimer.start(captureLength)}function recordfail(err){alert("Error capturing audio: "+
err)}return qtAudioCapture}var qtAudioCapture=new qtAudioCaptureDef;
function MP3MediaRecorder(audioCtx,s){this.context=audioCtx;this.stream=s;var maxSamples=1152;var floatTo16BitPCM=function floatTo16BitPCM(input,output){for(var i=0;i<input.length;i++){var s=Math.max(-1,Math.min(1,input[i]));output[i]=s<0?s*32768:s*32767}};this.start=function(){var _this=this;this.microphone=this.context.createMediaStreamSource(this.stream);this.processor=this.context.createScriptProcessor(2048,1,1);this.mp3encoder=new lamejs.Mp3Encoder(1,this.context.sampleRate,64);this.analyser=
audioCtx.createAnalyser();this.analyser.smoothingTimeConstant=.3;this.analyser.fftSize=2048;this.processor.onaudioprocess=function(event){audiocapIndicator(_this.analyser);var array=event.inputBuffer.getChannelData(0);var data=new Float32Array(array);var mono=new Int16Array(array.length);floatTo16BitPCM(data,mono);var remaining=mono.length;for(var i=0;remaining>=0;i+=maxSamples){var left=mono.subarray(i,i+maxSamples);var mp3buf=_this.mp3encoder.encodeBuffer(left);var b=new Blob([new Int8Array(mp3buf)],
{type:"audio/mp3"});_this.ondataavailable({data:b});remaining-=maxSamples}};this.microphone.connect(this.analyser);this.analyser.connect(this.processor);this.processor.connect(this.context.destination)};this.stop=function(){if(this.processor&&this.microphone){this.microphone.disconnect();this.processor.disconnect();this.processor.onaudioprocess=null}var mp3buf=this.mp3encoder.flush();var b=new Blob([new Int8Array(mp3buf)],{type:"audio/mp3"});this.ondataavailable({data:b});this.onstop()}}
function audiocapIndicator(analyser){var array=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(array);var values=0;var min=255;var max=0;var length=array.length;for(var i=0;i<length;i++){values+=array[i];if(array[i]>max)max=array[i];if(array[i]<min)min=array[i]}var average=values/length;var scale10=Math.floor(10*average/128);$("#audiocap-indicator-inner").removeClass();$("#audiocap-indicator-inner").addClass("scale10at"+scale10)}
function startRecording(){$("#micstart").prop("disabled",true);$("#micstart").text("Recording...");$("#micstart").addClass("disabled");$("#micstart").off("click");$("#micstop").prop("disabled",false);$("#micstop").removeClass("disabled");$("#micstop").on("click",stopRecording);qt.start(0)}function stopRecording(){$("#micstart").text("Recording Ended");$("#micstop").prop("disabled",true);$("#micstop").addClass("disabled");$("#micstop").off("click");qt.stop()}
function pad(num,size){var s="000000000"+num;return s.substr(s.length-size)}
function qtContainerDef(){function qtContainer(){}qtContainer.prototype=Object.create(qtBase.prototype);qtContainer.prototype.constructor=qtContainer;var handlers=[];function highlightReferenceWord(jqobj){var found=false;$("#itext .referenceword").removeClass("highlight");$("#accordion .referenceword").removeClass("highlight");$(".accordion-body.in",jqobj).each(function(index,elem){var list=$(".referenceword",elem);list.addClass("highlight");if(list.length>0)found=true});if(found)$("#itext .referenceword").addClass("highlight")}
qtContainer.prototype.enter=function(answer,restore){handlers=[];var sqa=[];var sqr=[];var sqnum=[];var i=0;$(".subquestion,.subquestion-example").each(function(){sqnum[i]=$(this).data("number");if(typeof sqnum[i]==="undefined")return;var qtype=$(this).data("qtype");sqa[i]="";sqr[i]="";if(answer.length>0)sqa[i]=answer.split("|")[sqnum[i]];if(restore.length>0)sqr[i]=restore.split("|")[sqnum[i]];var handler;if(qtype==1)handler=new qtMC;else if(qtype==4)handler=new qtMatch;else if(qtype==3)handler=new qtFIB;
else if(qtype==28)handler=new qtDnDText;if(handler!=null){handlers.push(handler);handler.prepare(sqa[i],sqr[i],sqnum[i])}i++});for(i=0;i<handlers.length;i++)handlers[i].enter(sqa[i],sqr[i],sqnum[i]);$(".accordion-toggle").click(function(){$(".accordion-toggle").not(this).addClass("collapsed")});$("#accordion").on("shown",function(){highlightReferenceWord($(this))});$("#accordion").on("hidden",function(){highlightReferenceWord($(this))})};qtContainer.prototype.calcAnswer=function(callback){var answer=
"";var i=0;$(".subquestion,.subquestion-example").each(function(){var sqnum=$(this).data("number");if(typeof sqnum==="undefined")return;if(i++>0)answer+="|";answer+=handlers[sqnum].calcAnswer(null,sqnum)});callback("OK",answer)};qtContainer.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;var unanswered=0;var complete=0;var total=0;$(".subquestion").each(function(){var sqnum=$(this).data("number");if(typeof sqnum==="undefined")return;var s=handlers[sqnum].getState(sqnum);if(s==
STATE_UNANSWERED)unanswered++;else if(s==STATE_COMPLETE)complete++;total++;if(s==STATE_COMPLETE)$("#sq-complete-"+sqnum).show();else $("#sq-complete-"+sqnum).hide()});if(!$("#container-data").data("requirecomplete"))return STATE_INAPP;if(unanswered==total)return STATE_UNANSWERED;else if(complete<total)return STATE_INCOMPLETE;return STATE_COMPLETE};return qtContainer}var qtContainer=new qtContainerDef;
function qtBranchDef(){function qtBranch(){}qtBranch.prototype=Object.create(qtBase.prototype);qtBranch.prototype.constructor=qtBranch;qtBranch.prototype.enter=function(answer,restore){$(".ev_branch").click(function(){$(".ev_branch").removeClass("branch-selected");$(this).addClass("branch-selected");$("#branchModal-confirm").data("index",$(this).data("index"));$("#branchModal").modal("show")});$(".ev_branch_confirm").click(function(){var answer=$(this).data("index");qt.answer(answer,{})});setState()};
qtBranch.prototype.calcAnswer=function(callback){var answer="-1";callback("OK",answer)};qtBranch.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;return STATE_UNANSWERED};return qtBranch}var qtBranch=new qtBranchDef;
function qtDnDTextDef(){function qtDnDText(){}qtDnDText.prototype=Object.create(qtBase.prototype);qtDnDText.prototype.constructor=qtDnDText;qtDnDText.prototype.prepare=function(answer,restore,sqnum){if(typeof sqnum==="undefined")sqnum=0;var qnumber=$("#subquestion-"+sqnum).data("qnumber");$("[id^='dndtext-draggable-"+qnumber+"-']").draggable({revert:true,revertDuration:0,appendTo:"#page",helper:function(){var clone=$(this).clone();$(clone).css("width",$(this).width());$(clone).on("wheel",function(ev,
delta){var top=ev.pageY;var left=ev.pageX;var delta=ev.originalEvent.deltaY;$(".et2-scrollable,.et2-scrollIntoViewContainer").each(function(i,e){if(inside(top,left,e)){var pos=$(e).scrollTop();$(e).scrollTop(pos+delta)}})});return clone},start:function(e,ui){if(!$("#qtparams").data("clonednd"))$(this).addClass("dndtext-cloned");$("#page").addClass("dndtext-dragging")},stop:function(){if(!$("#qtparams").data("clonednd"))$(this).removeClass("dndtext-cloned");$("#page").removeClass("dndtext-dragging")},
drag:function(ev,ui){var top=ev.pageY;var left=ev.pageX;$(".dndtext-droparea").removeClass("dndtext-droparea-hover");$(".dndtext-droparea").each(function(i,e){if(inside(top,left,e))$(e).addClass("dndtext-droparea-hover")});var qtop=$("#questionframe").offset().top;var qleft=$("#questionframe").offset().left;var qw=$("#questionframe").width();var qh=$("#questionframe").height();if(top<qtop)top=qtop;if(top>qtop+qh)top=qtop+qh;if(left<qleft)left=qleft;if(left>qleft+qw)left=qleft+qw;var w=$(this).width();
var h=$(this).height();ui.position.top=top-h/2;ui.position.left=left-w/2}});$("[id^='dndtext-droparea-"+qnumber+"-']").droppable({tolerance:"pointer",drop:function(event,ui){var i=ui.draggable.data("number");var a=$(this).data("answer");if(i!=a){revert($(this));$(this).data("answer",i);$(this).html(ui.draggable.html());$(this).removeClass("dndtext-empty");if(!$("#qtparams").data("clonednd")){ui.draggable.addClass("dndtext-dropped");ui.draggable.draggable("disable")}else{var count=$(".dndtext-droparea").filter(function(){return $(this).data("answer")==
i}).length;if(ui.draggable.data("maxclones")!=0&&count==ui.draggable.data("maxclones")){ui.draggable.addClass("dndtext-dropped");ui.draggable.draggable("disable")}}}setState()}});$("[id^='dndtext-droparea-"+qnumber+"']").click(function(){revert($(this));setState()})};qtDnDText.prototype.enter=function(answer,restore,sqnum){if(typeof sqnum==="undefined")sqnum=0;var qnumber=$("#subquestion-"+sqnum).data("qnumber");if(answer.length>0)$.each(answer.split(";"),function(i,ax){if(ax!=-1){if(String(ax).split("-").length==
1)ax=qnumber+"-"+ax;var da=$("#dndtext-droparea-"+qnumber+"-"+(i+1));var dr=$("#dndtext-draggable-"+ax);da.data("answer",ax);da.html(dr.html());da.removeClass("dndtext-empty");dr.addClass("dndtext-dropped");dr.draggable("disable")}})};function inside(top,left,e){var je=$(e);var etop=je.offset().top;var eleft=je.offset().left;var ew=je.width();var eh=je.height();return top>=etop&&top<=etop+eh&&left>=eleft&&left<=eleft+ew}qtDnDText.prototype.calcAnswer=function(callback,sqnum){if(typeof sqnum==="undefined")sqnum=
0;var qnumber=$("#subquestion-"+sqnum).data("qnumber");var answer="";for(i=1;true;i++){var da=$("#dndtext-droparea-"+qnumber+"-"+i);if(!da.length)break;if(i>1)answer+=";";var ax=da.data("answer");if(String(ax).indexOf(qnumber+"-")!=-1)ax=ax.split("-")[1];answer+=ax}if(callback==null)return answer;else callback("OK",answer)};qtDnDText.prototype.getState=function(sqnum){if(typeof sqnum==="undefined")sqnum=0;var qnumber=$("#subquestion-"+sqnum).data("qnumber");if(isAnswered())return STATE_ANSWERED;var answered=
0;var unanswered=0;$("[id^='dndtext-droparea-"+qnumber+"-']").each(function(){if($(this).data("answer")==-1)unanswered++;else answered++});if(answered==0)return STATE_UNANSWERED;if(unanswered>0)return STATE_INCOMPLETE;return STATE_COMPLETE};function revert(droparea){var i=droparea.data("answer");if(i!=-1){$("div[data-number='"+i+"']").removeClass("dndtext-dropped");$("div[data-number='"+i+"']").draggable("enable");droparea.addClass("dndtext-empty");droparea.html("&nbsp;");droparea.data("answer",-1)}}
return qtDnDText}var qtDnDText=new qtDnDTextDef;
function qtAdvancedHSDef(){function qtAdvancedHS(){}qtAdvancedHS.prototype=Object.create(qtBase.prototype);qtAdvancedHS.prototype.constructor=qtAdvancedHS;function page(){this.isEnd=true;this.isFIB=false;this.hotspots=[]}function hotspot(id,type,clicktype,action,x,y,width,height){this.id=id;this.type=type;this.clicktype=clicktype;this.action=action;this.x=x;this.y=y;this.width=width;this.height=height;this.contains=function(cx,cy){return cx>=x&&cx<=x+width&&cy>=y&&cy<=y+height};this.isClick=function(ct){var mask=
ct==1?1:4;return(clicktype&mask)!=0}}function coord(clicktype,x,y){this.clicktype=clicktype;this.x=Math.round(x);this.y=Math.round(y)}function advstate(){this.curpage=-1;this.pathcoords=[];this.misclick=0}function showPage(pageno){$(".advhs-page").hide();$("#advhs-page-"+pageno).show();state.curpage=pageno;saveState()}function saveState(){var statestr=JSON.stringify(state);var qid=$("#qtparams").data("qid");sessionStorage.setItem("advhs-"+qid,statestr)}var state;var pages=[];var hotspots=[];var crossX=
-1;var crossY=-1;function doClick(ev){var ct;if(ev.which==1)ct="L";else if(ev.which==3)ct="R";else ct="?";var page=pages[state.curpage-1];if(page.isFIB){$(".cross").hide();return}else if(page.isEnd){$(".cross").hide();var selector="#advhs-leftclick";if(ev.which==3)selector="#advhs-rightclick";clicktype=ct;var advhs=$("#advhs").offset();crossX=Math.round(ev.pageX-advhs.left);crossY=Math.round(ev.pageY-advhs.top);$(selector).css("left",crossX+"px");$(selector).css("top",crossY+"px");$(selector).show();
return}for(var i=0;i<page.hotspots.length;i++){var hs=page.hotspots[i];if(!hs.isClick(ev.which))continue;if(!hs.contains(ev.offsetX,ev.offsetY))continue;var c=new coord(ct,ev.offsetX,ev.offsetY);state.pathcoords.push(c);showPage(hs.action);return}state.misclick++;saveState();var n=$("#qtparams").data("misclick")-state.misclick;$("#advhs_misclick_count").text(n);if(n==0){$("#advhs_misclick_answer").show();$("#advhs_tryagain").hide();$("#advhs_ok").show();$("#advhs_ok").click(function(){$("#advhsModal").modal("hide");
doAnswer(null)})}else{$("#advhs_tryagain").show();$("#advhs_ok").hide()}$("#advhsModal").modal("show")}function doRestore(answer,restore){var aa=answer.split(";");var bb=restore.split(";");var last=0;for(i=1;i<aa.length;i++){var id=aa[i];var hs=hotspots[id];if(hs.action){state.curpage=hs.action;last=i}}if(last<bb.length){var cc=bb[last].split(":");if(cc[0]=="T")$("#advhs-hs-fib-"+cc[1]).val(cc[2]);else{var selector="#advhs-leftclick";if(cc[0]=="R")selector="#advhs-rightclick";$(selector).css("left",
cc[1]+"px");$(selector).css("top",cc[2]+"px");$(selector).show()}}}qtAdvancedHS.prototype.enter=function(answer,restore){state=null;pages=[];crossX=-1;crossY=-1;state=new advstate;state.curpage=1;$(".advhs-page").each(function(){var p=new page;pages.push(p)});$(".advhs-hs").each(function(){var pageno=$(this).data("page");var page=pages[pageno-1];var type=$(this).data("type");if(type==1)page.isEnd=false;else if(type==2)page.isFIB=true;var clicktype=0;if($(this).data("leftclick")==true)clicktype+=1;
if($(this).data("rightclick")==true)clicktype+=4;var hs=new hotspot($(this).data("id"),type,clicktype,$(this).data("action"),$(this).data("x"),$(this).data("y"),$(this).data("width"),$(this).data("height"));page.hotspots.push(hs);hotspots[hs.id]=hs});$("#advhs").bind("contextmenu",function(e){e.preventDefault();doClick(e,false);return false});$("#advhs").on("click",function(e){doClick(e,false)});var qid=$("#qtparams").data("qid");var statestr=sessionStorage.getItem("advhs-"+qid);if(statestr!=null)state=
JSON.parse(statestr);else if(restore.length>0)doRestore(answer,restore);showPage(state.curpage)};qtAdvancedHS.prototype.exit=function(){var qid=$("#qtparams").data("qid");sessionStorage.removeItem("advhs-"+qid)};qtAdvancedHS.prototype.calcAnswer=function(callback){if(crossX!=-1){var c=new coord(clicktype,crossX,crossY);state.pathcoords.push(c)}var answer="";for(var i=0;i<state.pathcoords.length;i++){answer+=state.pathcoords[i].clicktype;answer+=":";answer+=state.pathcoords[i].x;answer+=":";answer+=
state.pathcoords[i].y;answer+=";"}$(".advhs-hs-fib").each(function(){if($(this).data("page")==state.curpage)answer+="T:"+$(this).data("id")+":"+escape($(this).val())+";"});callback("OK",answer)};qtAdvancedHS.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;else return STATE_INAPP};return qtAdvancedHS}var qtAdvancedHS=new qtAdvancedHSDef;
function qtInfoDef(){function qtInfo(){}qtInfo.prototype=Object.create(qtBase.prototype);qtInfo.prototype.constructor=qtInfo;qtInfo.prototype.enter=function(answer,restore){$(".ev_accept").click(function(e){qt.answer("1",{})});$(".ev_decline").click(function(e){$("#requireAcceptModal").modal("show");$("#requireAcceptModal").off("hidden");$("#requireAcceptModal").on("hidden",tools.magnifier.refresh);setTimeout(tools.magnifier.refresh,200)});$(".ev_warning_decline").click(function(e){$("#requireAcceptModal").modal("hide");
qt.answer("2",{})})};qtInfo.prototype.calcAnswer=function(callback){var answer="0";if(callback==null)return answer;else callback("OK",answer)};qtInfo.prototype.getState=function(){var requireAccept=$("#requireAcceptModal").length==1;return requireAccept?STATE_INCOMPLETE:STATE_INAPP};return qtInfo}var qtInfo=new qtInfoDef;
function qtPunctuationDef(){function qtPunct(){}qtPunct.prototype=Object.create(qtBase.prototype);qtPunct.prototype.constructor=qtPunct;qtPunct.prototype.enter=function(answer,restore){var text=$("#punct-params").data("sourcetext");var changes=$("#punct-params").data("maxchanges");var chars=$("#punct-params").data("chars").split(",");var keyboard=$("#punct-params").data("keyboard").split(",");$(".punctuation").punctuation({doc:text,maxChanges:changes,keys:keyboard,chars:chars});if(answer&&answer!=
-1)$(".punctuation").punctuation("resume",answer);if(restore&&restore!=-1)$(".punctuation").punctuation("resume",restore);$(".punctuation").punctuation().bind("punctuationstatus",function(event,status){$("#punctuation-changes").text(status.remaining);setState()});var status=$(".punctuation").punctuation("getStatus");$("#punctuation-changes").text(status.remaining)};qtPunct.prototype.calcAnswer=function(callback){var answer=$(".punctuation").punctuation("answer");if(callback==null)return answer;else callback("OK",
answer)};qtPunct.prototype.getState=function(){if(isAnswered())return STATE_ANSWERED;var punctstatus=$(".punctuation").punctuation("getStatus");if(!punctstatus.answerable)return STATE_UNANSWERED;else return STATE_COMPLETE};return qtPunct}var qtPunct=new qtPunctuationDef;
function fib_numkeyFilter(field,e){var code;if(typeof e.charCode=="number"){if(e.keyCode)return true;code=e.charCode}else code=e.keyCode;var ch=String.fromCharCode(code);if(ch>="0"&&ch<="9")return true;else if(ch==".")return field.value.indexOf(".")==-1;else if(ch=="-")return field.value.indexOf("-")==-1;return false}
function fib_numkeyupFilter(field,e){var code;if(typeof e.charCode=="number"){if(e.which!=109)return true}else if(e.keyCode!=189&&e.keyCode!=109)return true;var txt=field.value;var pos=txt.indexOf("-");if(pos>0){var temp=new Array;temp=txt.split("-");field.value=temp[0]+temp[1]}return true}
function fib_numBlur(field,e){var error=false;var numdot=0;var i;var txt=field.value;for(i=0;i<txt.length;i++){var ch=txt.charAt(i);if(ch=="-"&&i!=0)error=true;if(ch==".")numdot++;if(numdot>1)error=true;if((ch<"0"||ch>"9")&&ch!="."&&ch!="-")error=true;if(error){field.select();alert($("#qtparams").data("badnumtext")+" "+field.value);field.value="";setState();return false}}return true}
function trueNoBubble(event){if(!event)event=window.event;if(!event)return true;if(event.stopPropagation)event.stopPropagation();else event.cancelBubble=true;return true}function escape(text){var res="";for(var i=0;i<text.length;i++){var chr=text.charAt(i);switch(chr){case ":":res+="\\k";break;case ";":res+="\\s";break;case "&":res+="\\a";break;case "\n":res+="\\n";break;case "\r":res+="\\r";break;case "\t":res+="\\t";break;case "\\":res+="\\";default:res+=chr}}return res};
