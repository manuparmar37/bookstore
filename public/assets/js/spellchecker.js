(function(spellchecker,$,undefined){var current_lang=null;var updateTimeout=null;var wordcache=new Map;function log(msg){}function spell_menuselect(){var items=this.parent()._items;for(var i=0;i<items.length;i++)items[i].active(false);this.active(true);current_lang=this.text();wordcache=new Map;spellchecker.update(1)}function getDocument(){var tinline=$("#params").data("tinymceinline")||false;if(tinline)return $("#essay");return $("#essay_ifr").contents().find("#tinymce")}spellchecker.setupEditor=
function(ed){current_lang=$("#essaylangs").data("default");var languages=[];$("#essaylangs li").each(function(){var lang=$(this).text();languages.push(lang)});var menuli=null;if(languages.length>1){menuli=[];$.each(languages,function(i,e){var langdef={text:e,active:e==current_lang,selectable:true,onclick:spell_menuselect};menuli.push(langdef)})}ed.addButton("et2spell",{type:menuli==null?"button":"splitbutton",icon:"spellchecker",tooltip:GUI_SPELLCHECKER_TOOLTIP,onclick:spellchecker.showNextWord,menu:menuli})};
spellchecker.update=function(_timeout){var timeout=_timeout?_timeout:500;if(updateTimeout!=null)clearTimeout(updateTimeout);updateTimeout=setTimeout(runCheck,timeout)};spellchecker.strip=function(x){var $div=$("<div/>").append(x);$div.find("span.spellcheck-error").contents().unwrap();return $div.html()};function runCheck(didnetwork){clearTimeout(updateTimeout);updateTimeout=null;var ed=tinymce.get("essay");if(ed==null)return;var bookmark=null;if(ed.hasFocus())bookmark=ed.selection.getBookmark();var doc=
getDocument();doc.find("span.spellcheck-error").contents().unwrap();log("actual html: "+doc.html());var tokens=[];$.each(doc.contents(),function(i,e){splitHtml("",tokens,e)});var delta=0;for(i=0;i<tokens.length;i++){var t=tokens[i];t.position+=delta;if(!t.isText())continue;var s=t.string.replace(/>/g,"&gt;").replace(/</g,"&lt;");delta+=s.length-t.string.length;t.string=s}var uwords={};var text="";var i;for(i=0;i<tokens.length;i++){var t=tokens[i];t.dump();if(!t.isText())continue;if(!t.isSeparator()&&
t.string.length>0&&!wordcache.has(t.string))uwords[t.string]="1";text+=t.string}var hwords=[];$.each(uwords,function(w,e){w=w.replace(/&gt;/g,">").replace(/&lt;/g,"<");log("CHECKING: "+w);hwords.push(w)});if(hwords.length>0&&!didnetwork)$.post("spellcheck.do",{"langname":current_lang,"words[]":hwords},function(data){$.each(data.errors,function(i,e){wordcache.set(e.word,e.suggestions)});$.each(hwords,function(i,w){if(wordcache.get(w)==null)wordcache.set(w,true)});runCheck(true)}).error(function(){});
var id=0;for(i=0;i<tokens.length;i++){var t=tokens[i];if(!t.isText())continue;var spinfo=wordcache.get(t.string);if(spinfo==null||spinfo==true)continue;log("ERROR: "+t.string+" len="+t.string.length);id++;var w=t.string.replace(/'/g,"&apos;").replace(/"/g,"&quot;");var clazzes="spellcheck-error";if(BrowserDetect.browser==="Explorer"||BrowserDetect.browser==="Chrome"&&BrowserDetect.version<60)clazzes="notextdecoration "+clazzes;var start=new token(t.position,"<span id='et2sp"+id+"' class='"+clazzes+
"' aria-invalid='spelling' data-word='"+w+"'>","span");var end=new token(t.getCurrentPosition(),"</span>","span");insertStart(tokens,start);insertEnd(tokens,end)}for(i=tokens.length-1;i>=0;i--){var t=tokens[i];if(t.isText())continue;text=text.slice(0,t.position)+t.string+text.slice(t.position)}doc.html(text);log("result html: "+doc.html());if(bookmark!=null)ed.selection.moveToBookmark(bookmark);doc.find("span.spellcheck-error").contextmenu(function(ev){ev.preventDefault();var id=$(this).attr("id");
var word=$(this).data("word");showMenu(id,word)});$("body").click(function(){$("#spellcheckmenu").hide();doc.find(".spellcheck-selected").removeClass("spellcheck-selected");doc.find("#spellcheck-marker").remove()});doc.click(function(){$("#spellcheckmenu").hide();doc.find(".spellcheck-selected").removeClass("spellcheck-selected");doc.find("#spellcheck-marker").remove()});doc.find("#spellcheck-marker").each(function(){if($(this).attr("replaced")=="true")return;$(this).next(".spellcheck-error").addClass("spellcheck-selected")})}
spellchecker.showNextWord=function(){var ed=tinyMCE.activeEditor;ed.selection.collapse(0);ed.execCommand("mceInsertContent",false,"<span id='et2cursor'></span>");var doc=getDocument();var all=doc.find("span.spellcheck-error,span.spellcheck-selected,#spellcheck-marker,#spellcheck-marker-end,#et2cursor");var pickNext=false;var first=true;var newsel=null;var listA=[];var listB=[];var found=false;$.each(all,function(){if(found)listA.push(this);else listB.push(this);if($("#spellcheckmenu").is(":visible")){if($(this).attr("id")==
"spellcheck-marker-end")found=true}else if($(this).attr("id")=="et2cursor")found=true});all=listA.concat(listB);$.each(all,function(){if($(this).hasClass("spellcheck-error")){newsel=$(this);return false}});doc.find("#et2cursor").remove();doc.find("#spellcheck-marker").remove();doc.find("#spellcheck-marker-end").remove();doc.find(".spellcheck-selected").removeClass("spellcheck-selected");if(newsel==null)return;newsel.addClass("spellcheck-selected");newsel.before("<span id='spellcheck-marker'></span>");
newsel.after("<span id='spellcheck-marker-end'></span>");var word=newsel.data("word");showMenu(newsel.attr("id"),word)};function showMenu(id,word){$("#spellcheckmenu").hide();$("#spellcheckmenu").empty();$("#spellcheckmenu").css("height","");if($("#"+id).closest(":scrollable").length>0)$("#"+id).scrollintoview({viewPadding:16,complete:function(){showMenuScrolled(id,word)}});else showMenuScrolled(id,word)}function showMenuScrolled(id,word){var empty=true;var spinfo=wordcache.get(word);if(spinfo==null||
spinfo==true);else $.each(spinfo,function(i,e){var w=e.replace(/'/g,"&apos;").replace(/"/g,"&quot;");$("#spellcheckmenu").append("<li><a href='#' role='menuitem' tabindex='0' onclick='spellchecker.changeword(\""+id+'", "'+w+"\")'>"+e+"</a></li>");empty=false});if(empty)$("#spellcheckmenu").append("<li><a href='#' role='menuitem' tabindex='-1' onclick='spellchecker.changeword(\""+id+"\")'>No suggestion</a></li>");var doc=getDocument();var middlebarP=$("#middlebar").offset();var x=0;var y=0;var w=$("#spellcheckmenu").width();
var h=$("#spellcheckmenu").height();var tinline=$("#params").data("tinymceinline")||false;if(tinline){var toolbarP=$("#tbcont").offset();var wordP=doc.find("#"+id).offset();toolbarP.top-=40;x=wordP.left-middlebarP.left;y=wordP.top-h-20;if(y<toolbarP.top){h=h-(toolbarP.top-y);y=toolbarP.top;$("#spellcheckmenu").css("height",h+"px");$("#spellcheckmenu").css("overflow-y","auto")}}else{var iframepos=$("#essay_ifr").offset();var wordP=doc.find("#"+id).offset();y=wordP.top+iframepos.top-middlebarP.top-
h-15;if(y<0)y=wordP.top+iframepos.top-middlebarP.top+20;x=wordP.left+iframepos.left-middlebarP.left}setTimeout(function(){$("#spellcheckmenu").off("keydown");$("#spellcheckmenu").on("keydown",function(e){if(e.which==27){$("#spellcheckmenu").hide();spellchecker.changeword();e.preventDefault();e.stopPropagation()}if(e.which==88)spellchecker.showNextWord()});$("#spellchecktarget").addClass("open");$("#spellcheckmenu").show();$("#spellcheckmenu").css({position:"absolute",left:x,top:y});setTimeout(function(){$("#spellcheckmenu li a:first").focus()},
1)},1)}function token(position,string,node){this.position=position;this.string=string;this.node=node;this.separator=false;this.dump=function(){log(this.position+": "+this.string)};this.isText=function(){return this.node==null};this.isSeparator=function(){return this.separator};this.getCurrentPosition=function(){if(node!=null)return this.position;return this.position+this.string.length}}function splitHtml(indent,tokens,node){if(node.nodeType==3){if(node.nodeValue.length==0)return;var prev=getPreviousText(tokens);
if(prev==null){prev=new token(0,"");tokens.push(prev)}if(!prev.isText()){prev=new token(prev.position,"");tokens.push(prev)}var i;for(i=0;i<node.nodeValue.length;i++){var ch=node.nodeValue.charAt(i);if(/[\s.,!\?+-=@"$%&\/\(\);:<>\}]/.test(ch)){var tt=new token(prev.getCurrentPosition(),ch);tt.separator=true;tokens.push(tt);prev=new token(tt.getCurrentPosition(),"");tokens.push(prev)}else prev.string+=ch}return}var prev=getPreviousText(tokens);if(prev==null)prev=new token(0,"");var str="<"+node.nodeName;
var attrs=node.attributes;var i;for(i=attrs.length-1;i>=0;i--)str+=" "+attrs[i].name+'="'+attrs[i].value+'"';str+=">";tokens.push(new token(prev.getCurrentPosition(),str,node.nodeName));if(node.nodeName=="SPAN"&&$(node).data("mce-type")==="bookmark");else $.each($(node).contents(),function(i,e){splitHtml(indent+"  ",tokens,e)});if(node.nodeName!="BR"){prev=getPreviousText(tokens);if(prev==null)prev=new token(0,"");tokens.push(new token(prev.getCurrentPosition(),"</"+node.nodeName+">",node.nodeName))}}
function getPrevious(tokens){if(tokens.length==0)return new token(0,"");return tokens[tokens.length-1]}function getPreviousText(tokens){if(tokens.length==0)return new token(0,"");var i;for(i=tokens.length-1;i>=0;i--){if(tokens[i].node==="P")return tokens[i];if(tokens[i].isText())return tokens[i]}return null}function insertStart(tokens,tt){var i;for(i=0;i<tokens.length;i++){var t=tokens[i];if(t.position>tt.position){tokens.splice(i,0,tt);break}}}function insertEnd(tokens,tt){var i;for(i=tokens.length-
1;i>=0;i--){var t=tokens[i];if(t.position<=tt.position){tokens.splice(i,0,tt);break}}}spellchecker.changeword=function(id,word){$("#spellcheckmenu").hide();var doc=getDocument();if(id!=null){var span=doc.find("#"+id);if(word!=null)span.text(word);span.contents().unwrap()}spellchecker.update();doc.find("#spellcheck-marker").attr("replaced","true");var ed=tinyMCE.activeEditor;ed.selection.select(ed.dom.select("#spellcheck-marker")[0]);ed.selection.collapse(0)}})(window.spellchecker=window.spellchecker||
{},jQuery);
