(function(clock,$,undefined){var reminders=[];var reminderShowing=false;function zeroPad(num,places){var zero=places-num.toString().length+1;return Array(+(zero>0&&zero)).join("0")+num}var stopped=false;var paused=true;var time=0;var lastUpdate=-1;var timervalue;var interval=null;var interval2=null;clock.now=function(){return(new Date).valueOf()};clock.getValue=function(){return timervalue};clock.setDisplayed=function(isPaused){if(typeof Storage!=="undefined"){var rid=$("#params").data("resultid");
var qid=$("#qtparams").data("qid");var saved=sessionStorage.getItem("time-"+rid);var data=JSON.parse(saved);if(data==null||data.qid!=qid||isNaN(data.time)){var cdt=$("#clock").data("delta");time=cdt||0}else{time=data.time;var cdt=$("#clock").data("delta");if(!time&&cdt)time=cdt}}else time=0;if(!isPaused)paused=false;lastUpdate=clock.now();calcTimervalue();if(interval==null)interval=window.setInterval("clock.tick()",200);var heartbeat=$("#params").data("oheartbeat");if(heartbeat&&interval2==null)interval2=
window.setInterval("clock.heartbeat()",60*1E3)};clock.clearStored=function(){if(typeof Storage!=="undefined"){var rid=$("#params").data("resultid");sessionStorage.removeItem("time-"+rid)}};clock.heartbeat=function(){var qtype=$("#qtparams").data("type");if(qtype==18)return;var spent=clock.getTimeSpent();var qid=$("#qtparams").data("qid");var duration0=$("#qtparams").data("duration");$.post("itemProgress.do",{"progress":"","qid":qid,"duration0":duration0,"time":spent})};clock.setLeave=function(){paused=
true};clock.getTimeSpent=function(){return time};clock.addTimeSpent=function(n){if(n>0)time+=n;return time};clock.getTotalTimeSpent=function(){return $("#qtparams").data("duration")+time};clock.setStopped=function(b){stopped=b};clock.pause=function(){paused=true};clock.resume=function(){paused=false};function calcTimervalue(){timervalue=0;var start=$("#clock").data("start");var max=$("#clock").data("max");if(max==null||max=="")return false;var ms=start+time;var sec=ms/1E3;timervalue=max-ms;return true}
clock.tick=function(){var autoanswer=parseInt($("#qtparams").data("autoanswer"));if(stopped&&(autoanswer<=0||isAnswered()))return;if(paused)return;var now=clock.now();var delta=-1;if(lastUpdate!=-1){delta=now-lastUpdate;if(delta>1E3)delta=1E3;else if(delta<0)delta=200}if(delta>0)time+=delta;lastUpdate=now;if(typeof Storage!=="undefined"){var rid=$("#params").data("resultid");var qid=$("#qtparams").data("qid");var data={"time":time,"qid":qid};sessionStorage.setItem("time-"+rid,JSON.stringify(data))}if(!calcTimervalue()){$("#params").trigger("et2:clock:tick");
return}var left=timervalue/1E3;if(autoanswer>0)left=autoanswer-clock.getTotalTimeSpent()/1E3;if(left<=0)if(autoanswer<=0){clock.setLeave();modals=[];$(".modal:visible").each(function(){modals.push(this);$(this).modal("hide")});$("#endOfTimeModal").modal("show");$(".ev_endoftime_ok").off("click");$(".ev_endoftime_ok").one("click",function(){$("#endOfTimeModal").modal("hide");if(!navAnswer("end")){if(this_itemevent!=null)this_itemevent=itemevent.end(this_itemevent);internalEndTest()}});return}else if(!isAnswered()){clock.pause();
$("#itemNavModal").modal("hide");autoanswerTimeout();return}var ps=$("#clock .bar");if(ps.length>0){if(autoanswer>0&&isAnswered())left=0;ps.attr("data-transitiongoal",left).progressbar();var desc=$("#clockdesc");if(left==0)desc.text(GUI_TIME_ZERO);else{var sec=left%60;var min=left/60;sec=parseInt(sec);min=parseInt(min);if(sec==0)desc.text(lang(GUI_TIME_MIN,min));else desc.text(lang(GUI_TIME_MINSEC,min,sec))}}var show=null;var ii;for(ii=0;ii<reminders.length;ii++){var rr=reminders[ii];if(left>=rr-
15&&left<=rr){show=reminders[ii];break}}if(show!=null){if(!reminderShowing){reminderShowing=true;var min=parseInt(show/60);$("#clock").data("title",lang(GUI_TIMEWARNING_MSG,min));$("#clock").data("placement","bottom");$("#clock").data("trigger","manual");$("#clock").tooltip("show");$(".tooltip").attr("role","alert")}}else if(reminderShowing){reminderShowing=false;$("#clock").tooltip("destroy")}$("#params").trigger("et2:clock:tick")};clock.format=function(seconds){var sec=seconds%60;var min=seconds/
60;sec=parseInt(sec);min=parseInt(min);return zeroPad(min,2)+":"+zeroPad(sec,2)};clock.getTimeLeft=function(){if(!calcTimervalue())return null;else return timervalue/1E3};clock.init=function(){var timelimits=$("#params").data("timelimits");if(timelimits!=null&&timelimits!=""){timelimits=String(timelimits);var limits=timelimits.split(";");var ii;for(ii=1;ii<limits.length;ii++){var n=parseInt(limits[ii]);reminders[ii-1]=n}}}})(window.clock=window.clock||{},jQuery);
(function(xtimer,$,undefined){var duration=0;var interval=null;var time0=null;var left;var timecounter;var lasttick;xtimer.setDuration=function(dur){duration=dur};xtimer.start=function(){if(window.performance&&window.performance.now)xtimer.now=function(){return window.performance.now()};else xtimer.now=function(){return clock.now()};$("#timer .bar").attr("aria-valuemax",duration);$("#timer").css("visibility","visible");left=duration;updateDisplay(left);time0=this.now();timecounter=0;lasttick=time0;
window.setTimeout(xtimer.tick,200)};xtimer.stop=function(){$("#timer").css("visibility","hidden");if(interval==null)return;window.clearInterval(interval);interval=null};xtimer.tick=function(){var now=xtimer.now();var elapsed=now-time0;left=duration*1E3-(now-time0)+999;left/=1E3;updateDisplay(left);if(elapsed>=duration*1E3)xtimer.stop();else{timecounter+=now-lasttick;lasttick=now;var diff=now-time0-timecounter;window.setTimeout(xtimer.tick,200-diff)}};function updateDisplay(){var str=clock.format(left);
$("#timer .bar").attr("data-transitiongoal",left).progressbar()}})(window.xtimer=window.xtimer||{},jQuery);
(function(capturetimer,$,undefined){var start;var time;var elapsed;var length;capturetimer.start=function(duration){start=window.performance.now();time=0;length=duration*1E3+100;lasttick=start;window.setTimeout(capturetimer.tick,100)};capturetimer.tick=function(){var now=window.performance.now();time+=100;elapsed=now-start;if(elapsed>=length){audiop.stopCapture();return}var diff=now-start-time;window.setTimeout(capturetimer.tick,100-diff)}})(window.capturetimer=window.capturetimer||{},jQuery);
(function(net,$,undefined){var timeout;var timeoutBlink;var visible;function cb_load(response,status,xhr){if(timeout!=null){clearTimeout(timeout);timeout=null}if(timeoutBlink!=null){clearTimeout(timeoutBlink);timeoutBlink=null}loading(3);errorcheck(null,response,status,xhr,null)}function cb_ajax_success(cb,data,status,xhr){if(arguments.length==0)return cb_ajax_success;if(arguments.length==1)return function(a,b,c){cb_ajax_success(cb,a,b,c)};var response=xhr.responseText;if(response==null)response=
xhr.responseXML;if(response==null)response=xhr.responseJSON;if(response==null)response="(undefined response?)";errorcheck(cb,response,status,xhr,data)}function cb_ajax_fail(xhr,status,errorThrown){var response=xhr.responseText;if(response==null)response=xhr.responseXML;if(response==null)response=xhr.responseJSON;if(response==null)response="(undefined response?)";errorcheck(null,response,status,xhr)}function errorcheck(cb,response,status,xhr,data){var error=response.indexOf("@@NO_SESSION@@")!=-1||
response.indexOf("@@KICKED@@")!=-1||response.indexOf("@@TEST_ERROR@@")!=-1;if(!error&&status!="error"){if(cb!=null)cb(data,status,xhr);return}if(response==""||response==null)response="<h1>Request timeout</h1> No response from the server. Check your network connection and then try to <a href='test.html'>reload</a> the page.";var doc=window.top.document.open("text/html","replace");doc.write(response);doc.close()}function pleasewait(){$("#message_wait").show();visible=false;timeoutBlink=setTimeout(pleasewait_blink,
1E3)}function pleasewait_blink(){if(visible){$("#message_blink").css({"visibility":"hidden"});timeoutBlink=setTimeout(pleasewait_blink,1E3)}else{$("#message_blink").css({"visibility":"visible"});timeoutBlink=setTimeout(pleasewait_blink,1E3)}visible=!visible}function makeformdata(params){var formdata=new FormData;$.map(params,function(value,key){if(Array.isArray(value))for(var i=0;i<value.length;i++)formdata.append(key+i,value[i]);else if(value!=null)formdata.append(key,value)});return formdata}net.load=
function(id,url,params){if(params==null)params={};params.time=clock.getTimeSpent();if(!isNaN(reloadCount)&&reloadCount<1&&(qt==null||qt.allowReload())){$.ajax({type:"GET",url:url,data:params}).done(function(){document.location.reload()});return}reloadCount--;timeout=setTimeout(pleasewait,5E3);loading(2);$(id).load(url,params,cb_load)};net.post=function(url,params,cb){reloadCount--;if(params==null)params={};params.time=clock.getTimeSpent();loading(2);$.post(url,params,cb_ajax_success(cb)).fail(cb_ajax_fail)};
net.postblob=function(url,params,cb){reloadCount--;if(params==null)params={};params.time=clock.getTimeSpent();loading(2);if(BrowserDetect.browser==="Explorer"&&BrowserDetect.version==9){var postdata="1=2";$.each(params,function(key,value){if(key!="file")postdata+="&"+key+"="+value;else postdata+="&fileie9="+encodeURIComponent(value)});$.post(url,postdata,cb)}else $.ajax({type:"POST",url:url,data:makeformdata(params),processData:false,contentType:false,enctype:"multipart/form-data"}).done(cb)};net.postblobSafe=
function(uploadUrl,names,files,md5sum,cb){if(!$.isArray(files)){files=[files];names=[names];md5sum=[md5sum]}var index=0;var pos=0;var chunkno=0;var chunkcounttarget=1;var maxTime=0;var total=0;var uploaded=0;$.each(files,function(index,value){if(value==null)return;total+=value.length});if(total==0)cb();var t0=clock.now();var ps=$("#message_upload .bar");ps.attr("aria-valuemax",total);ps.attr("data-transitiongoal",0).progressbar();ps.attr("data-start",clock.now());ps.data("message",GUI_UPLOAD_TEXT);
$("#message_upload").show();var barupdate=setInterval(function(){ps.attr("data-transitiongoal",uploaded).progressbar()},1E3);function sendChunks(){var chunkcount=chunkcounttarget;var len=files[index].length-pos;if(len>=chunkcount*8192)len=chunkcount*8192;else chunkcount=Math.floor(1+(len-1)/8192);log("chunkcount: "+chunkcount+" target: "+chunkcounttarget);var form=new FormData;form.append("id",names[index]);form.append("chunk0",chunkno);form.append("total",files[index].length);if(pos+len>=files[index].length)form.append("checksum",
md5sum[index]);var s=files[index].slice(pos,pos+len);var data=new Blob([s],{type:"application/octet-stream"});form.append("data",data);var tr0=clock.now();$.ajax({method:"POST",url:uploadUrl,data:form,processData:false,contentType:false,enctype:"multipart/form-data"}).done(function(data,textStatus,jqXHR){if(data.status==="restart"){uploaded-=pos;pos=0;chunkno=0;clearInterval(barupdate);$("#message_restart").show();$("#btn_restart").off("click");$("#btn_restart").click(function(){$("#message_restart").hide();
ps.attr("data-transitiongoal",uploaded).progressbar();setTimeout(sendChunks,0)});return}pos+=len;uploaded+=len;chunkno+=chunkcount;ps.attr("data-transitiongoal",uploaded).progressbar();var tr1=clock.now();var chunktime=tr1-tr0;log("chunk time: "+chunktime+"ms");if(chunktime>maxTime)maxTime=chunktime;else{var diff=maxTime-chunktime;maxTime-=diff/2}log("adjusted max time: "+maxTime+"ms");if(maxTime<250)chunkcounttarget*=4;else if(maxTime<2E3)chunkcounttarget*=2;else if(maxTime>5E3)chunkcounttarget/=
2;else if(maxTime>2E4)chunkcounttarget/=4;if(chunkcounttarget>32)chunkcounttarget=32;else if(chunkcounttarget<1)chunkcounttarget=1;if(pos>=files[index].length){index++;pos=0;chunkno=0}if(index>=files.length){ps.attr("data-transitiongoal",total).progressbar();clearInterval(barupdate);var tN=clock.now();log("DEBUG: upload done, time: "+(tN-t0)+"ms");$("#message_upload").hide();cb()}else setTimeout(sendChunks,0)}).fail(function(jqXHR,textStatus,errorThrown){chunkcounttarget=1;clearInterval(barupdate);
$("#message_retry").show();$("#btn_retry").off("click");$("#btn_retry").click(function(){$("#message_retry").hide();setTimeout(sendChunks,0)})})}setTimeout(sendChunks,0)};net.postblobSafeOLD=function(uploadUrl,names,files,md5sum,cb){if(!$.isArray(files)){files=[files];names=[names];md5sum=[md5sum]}var index=0;var pos=0;var chunkno=0;var total=0;var uploaded=0;$.each(files,function(index,value){if(value==null)return;total+=value.length});if(total==0)cb();var ps=$("#message_upload .bar");ps.attr("aria-valuemax",
total);ps.attr("data-transitiongoal",0).progressbar();ps.attr("data-start",clock.now());ps.data("message",GUI_UPLOAD_TEXT);$("#message_upload").show();var barupdate=setInterval(function(){ps.attr("data-transitiongoal",uploaded).progressbar()},1E3);function sendChunk(){var len=files[index].length-pos;if(len>4096)len=4096;var s="";for(var i=0;i<len;i++){var b=files[index][pos+i];s+=("0"+(b&255).toString(16)).slice(-2)}var sum=null;if(pos+len>=files[index].length)sum=md5sum[index];$.ajax({type:"POST",
url:uploadUrl,data:makeformdata({id:names[index],chunk:chunkno,data:s,checksum:sum}),processData:false,contentType:false,enctype:"multipart/form-data"}).done(function(data,textStatus,jqXHR){if(data.status==="restart"){uploaded-=pos;pos=0;chunkno=0;clearInterval(barupdate);$("#message_restart").show();$("#btn_restart").off("click");$("#btn_restart").click(function(){$("#message_restart").hide();ps.attr("data-transitiongoal",uploaded).progressbar();setTimeout(sendChunk,0)});return}pos+=len;uploaded+=
len;chunkno++;ps.attr("data-transitiongoal",uploaded).progressbar();if(pos>=files[index].length){index++;pos=0;chunkno=0}if(index>=files.length){ps.attr("data-transitiongoal",total).progressbar();clearInterval(barupdate);$("#message_upload").hide();cb()}else setTimeout(sendChunk,0)}).fail(function(jqXHR,textStatus,errorThrown){clearInterval(barupdate);$("#message_retry").show();$("#btn_retry").off("click");$("#btn_retry").click(function(){$("#message_retry").hide();setTimeout(sendChunk,0)})})}setTimeout(sendChunk,
0)}})(window.net=window.net||{},jQuery);
(function(pdf,$,undefined){var saved_scrollTop=-1;var loaded=1;function processPage(page){var desiredWidth=780;var vp0=page.getViewport(1);var scale=desiredWidth/vp0.width;var viewport=page.getViewport(scale);var canvas=document.getElementById("pdf-"+page.pageNumber);var context=canvas.getContext("2d");canvas.height=viewport.height;canvas.width=viewport.width;var renderContext={canvasContext:context,viewport:viewport};page.render(renderContext)}function scrollPDF(deltaY){if(deltaY==0)return;var pos=
$("#pdf-wrapper").scrollTop();$("#pdf-wrapper").scrollTop(pos+deltaY)}pdf.isLoaded=function(){return loaded!=0};pdf.load=function(textid,name){if($("#pdf-wrapper").length<1)return;loaded=0;$("#pdf-wrapper").scroll(function(){var div=document.getElementById("pdf-wrapper");saved_scrollTop=div.scrollTop});$("#pdf-wrapper").mouseenter(function(event){$("body").keydown(function(event){var div=document.getElementById("pdf-wrapper");switch(event.which){case 38:scrollPDF(-20);break;case 40:scrollPDF(20);
break;case 33:scrollPDF(-500);break;case 34:scrollPDF(500);break;default:break}})});$("#pdf-wrapper").mouseleave(function(event){$("body").off("keydown")});name=encodeURIComponent(name);var url="../resource/textdata/"+textid+"/"+name;PDFJS.workerSrc="../../js/pdf.worker.js";var doc=PDFJS.getDocument(url);if(!doc)return;doc.then(function(zpdf){var numpages=zpdf.numPages;var pages=[];for(var i=0;i<numpages;i++){var c=document.createElement("canvas");c.setAttribute("id","pdf-"+(i+1));$("#pdf-wrapper").append(c);
var p=zpdf.getPage(i+1);pages.push(p);p.then(processPage)}Promise.all(pages).then(function(){scrollPDF(saved_scrollTop);setTimeout(function(){loaded=1},300)})})}})(window.pdf=window.pdf||{},jQuery);
(function(audiop,$,undefined){var playlistId=-1;var playlist=[];var current=-1;var timer=null;var volume=5/6;var VOLUME_STEP=1/6;function setVolume(vol){volume=vol;if(volume<0)volume=0;else if(volume>1)volume=1;var audio=$(".audio-player");for(var i=0;i<audio.length;i++)audio[i].volume=volume;var scale10=Math.floor(10*volume);$(".volumeindicator").attr("class","volumeindicator");$(".volumeindicator").addClass("scale10at"+scale10);sessionStorage.setItem("volume",""+volume)}audiop.init=function(){current=
-1;playlist=[];playlistId=(new Date).getTime();$("#playlist span").each(function(i,e){playlist.push($(e).text())});$(".audio-player").on("ended",function(){$(".audio-ui").removeClass("active");if(playlist.length>0&&$(this).attr("id")=="audio-player0"){current++;playlistNext()}});$(".ev_audio").click(function(){var isActive=$(this).hasClass("active");var player=$(this).data("player");if(player!=null&&player>0||playlist.length===0){if(isActive){$(this).removeClass("active");$("#audio-player"+player)[0].pause()}else{$(".audio-ui").removeClass("active");
audiop.pause($(".audio-player"));$(this).addClass("active");$("#audio-player"+player)[0].play()}return}if(isActive){$(this).removeClass("active");$("#audio-player0")[0].pause()}else{if(timer!=null){clearTimeout(timer);timer=null}var audio=$("#audio-player"+player)[0];if(audio.paused&&audio.currentTime>0&&!audio.ended){$(this).addClass("active");$("#audio-player"+player)[0].play()}else pauseDone(playlistId)}});$(".ev_volumelower").click(function(){setVolume(volume-VOLUME_STEP)});$(".ev_volumehigher").click(function(){setVolume(volume+
VOLUME_STEP)});var savedvolume=sessionStorage.getItem("volume");if(savedvolume==null)setVolume(5/6);else setVolume(parseFloat(savedvolume));var end=$("#qtparams").data("end");if($("#qtparams").data("audioplaymode")>0&&!isAnswered()&&!end){current++;playlistNext()}};function playlistNext(){if(current>=playlist.length)return;var element=playlist[current];var match=/^goto:(\d+)/.exec(element);var count=0;while(match!=null){current=match[1];element=playlist[current];match=/^goto:(\d+)/.exec(element);
if(count++>100)return}var match=/^pause:([-\d]\d*)/.exec(element);if(match!=null){if(match[1]>=0){var duration=match[1];var x=playlistId;timer=setTimeout(function(){pauseDone(x)},duration*1E3)}return}var match=/^play:(\d+):(.*)/.exec(element);if(match!=null){play($("#audio-player0")[0],match[1],match[2]);return}var match=/^indicator_on:(\d+)/.exec(element);if(match!=null){$("#audio-indicator"+match[1]).addClass("active");current++;playlistNext();return}var match=/^indicator_off:(\d+)/.exec(element);
if(match!=null){$("#audio-indicator"+match[1]).removeClass("active");current++;playlistNext();return}var match=/^capture:(\d+):(\d+)/.exec(element);if(match!=null){capture(match[1],match[2]);return}var match=/^timer:(\d+)/.exec(element);if(match!=null){startTimer(match[1]);return}var match=/^addclass:([^:]+):(.*)/.exec(element);if(match!=null){var id=match[1];var clazz=match[2];$(id).addClass(clazz);current++;playlistNext();return}var match=/^removeclass:([^:]+):(.*)/.exec(element);if(match!=null){var id=
match[1];var clazz=match[2];$(id).removeClass(clazz);current++;playlistNext();return}var match=/^answer:/.exec(element);if(match!=null){doAnswer(null);return}}audiop.pause=function(audio){for(var i=0;i<audio.length;i++)audio[i].pause()};audiop.leave=function(){playlistId=-1;if(timer!=null){clearTimeout(timer);timer=null}};function pauseDone(id){if(id!=playlistId)return;timer=null;current++;playlistNext()}function play(audio,id,url){$(".audio-ui").addClass("active");if(mediaObjects[url])audio.src=
mediaObjects[url];else audio.src=url;if(audio.ended)audio.load();audio.play()}function stopAll(){$(".audio-player").each(function(i,e){var aa=$(e)[0];aa.removeAttribute("src");aa.load()})}function capture(num,duration){if(qtAC==null)return;qtAC.start(num,duration)}audiop.stopCapture=function stopCapture(){qtAC.stop();current++;playlistNext()};function startTimer(duration){if(duration==0)xtimer.stop();else{xtimer.setDuration(duration);xtimer.start()}current++;playlistNext()}})(window.audiop=window.audiop||
{},jQuery);var Delay=function(trigger){this.trigger=trigger;var unsatisfied=[];this.require=function(event){unsatisfied[event]=true;var t0=(new Date).getTime();$("#params").off(event);$("#params").on(event,function(){if($.isEmptyObject(unsatisfied))return;delete unsatisfied[event];if($.isEmptyObject(unsatisfied))$("#params").trigger(trigger)});return this}};
